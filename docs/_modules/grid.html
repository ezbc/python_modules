<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>grid &mdash; custom_modules 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="custom_modules 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">custom_modules 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for grid</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>


<span class="c1">################################################################################</span>
<span class="c1"># Classes</span>
<span class="c1">################################################################################</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="SpectralGrid"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid">[docs]</a><span class="k">class</span> <span class="nc">SpectralGrid</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A class for decomposing a cube into Gaussians. :-)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">Queue</span> <span class="kn">as</span> <span class="nn">queue</span>
    <span class="kn">import</span> <span class="nn">grid</span>

    <span class="c1"># Class variables</span>
    <span class="n">grid_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cube</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">spectral_axis</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">raAxis</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">decAxis</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">gaussAreaList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">region</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">__tile_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">__tile_param_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">__tile_ncomp_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">__directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">,</span><span class="s1">&#39;west&#39;</span><span class="p">,</span><span class="s1">&#39;north&#39;</span><span class="p">,</span><span class="s1">&#39;south&#39;</span><span class="p">,]</span>
    <span class="n">__tile_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">__tile_fit_limit</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">__invalid_tile_count</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fitsfile</span><span class="p">,</span><span class="n">box</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">noiseScale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">basesubtract</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">noiseRange</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">Tsys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Create an instance of SpectralGrid class. Requires an</span>
<span class="sd">        N-dimensional numpy array. Two dimensions of the array must be</span>
<span class="sd">        specified to build the Grid on. Creates a new Tile instance for each</span>
<span class="sd">        element in the 2-dimensional numpy array. The additional dimensions of</span>
<span class="sd">        the input array are stored in the Tile class instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitsFile : string</span>
<span class="sd">            Path to fits file to load.</span>

<span class="sd">        gridfile : grid_list</span>

<span class="sd">        box : list</span>
<span class="sd">            [brc_x,brc_y,tlc_x,tlc_y]</span>

<span class="sd">        noiseScale : int</span>
<span class="sd">            Noise profile multiplied by this scale.</span>

<span class="sd">        noiseRange : tuple,list</span>
<span class="sd">            2D tuple or list specifying noise range.</span>
<span class="sd">            ((velMin1,velMax1),(velMin2,velMax2))</span>

<span class="sd">        Tsys : float</span>
<span class="sd">            System temperature of the telescope in units of K.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
        <span class="c1"># Check optional keywords</span>
        <span class="k">if</span> <span class="n">fitsfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Please provide a fits image&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">noiseRange</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;Error: no velocity range selected for noise.&#39;</span>

        <span class="c1"># Create a Cube object</span>
        <span class="k">print</span> <span class="s1">&#39; Loading cube...&#39;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">h</span>

        <span class="c1"># Define axes arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span> <span class="o">=</span> <span class="n">make_velocityAxis</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raAxis</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">decAxis</span> <span class="o">=</span> <span class="n">make_radecAxes</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Create Tiles for the grid</span>
        <span class="n">tempList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cubeXSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cubeYSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cubeXSize</span><span class="p">,</span><span class="n">cubeYSize</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cubeXSize</span><span class="p">:</span>
            <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cubeXSize</span>
        <span class="k">elif</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cubeYSize</span><span class="p">:</span>
            <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cubeYSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">box</span>

        <span class="k">print</span> <span class="s1">&#39; Loading profiles...&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__invalid_tile_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">tempList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">SpectralTile</span><span class="p">(</span><span class="n">gridXPos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                              <span class="n">gridYPos</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                              <span class="n">imageXPos</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span>
                                              <span class="n">imageYPos</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span>
                                              <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="p">,</span>
                                              <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempList</span><span class="p">)</span>
            <span class="n">tempList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">noise1</span> <span class="o">=</span> <span class="n">noiseRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">noise2</span> <span class="o">=</span> <span class="n">noiseRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Subtract baselines from each profile</span>
        <span class="k">if</span> <span class="n">basesubtract</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39; Subtracting baseline from profiles...&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">subtract_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                                                         <span class="n">noise1</span><span class="p">,</span><span class="n">noise2</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39; Calculating noise characteristics...&#39;</span>

        <span class="c1"># Calculate noises from each profile</span>
        <span class="c1">#print noiseScale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_profileNoises</span><span class="p">(</span><span class="n">noise1</span><span class="p">,</span><span class="n">noise2</span><span class="p">,</span><span class="n">noiseScale</span><span class="o">=</span><span class="n">noiseScale</span><span class="p">,</span>
                                     <span class="n">Tsys</span><span class="o">=</span><span class="n">Tsys</span><span class="p">)</span>

<div class="viewcode-block" id="SpectralGrid.at_boundary"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.at_boundary">[docs]</a>    <span class="k">def</span> <span class="nf">at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True boundary exists in the direction specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : int</span>
<span class="sd">            Tile x position</span>
<span class="sd">        y : int</span>
<span class="sd">            Tile y position</span>
<span class="sd">        direction : str</span>
<span class="sd">            Direction to check boundary. Options are:</span>
<span class="sd">            &#39;north&#39;,&#39;south&#39;,&#39;east&#39;, or &#39;west&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="SpectralGrid.calculate_profileNoises"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.calculate_profileNoises">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_profileNoises</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">velMin</span><span class="p">,</span><span class="n">velMax</span><span class="p">,</span><span class="n">noiseScale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">Tsys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calcuates noise envelopes for each pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">noiseScale</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">noiseScale</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">if</span> <span class="n">Tsys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;System temperature not provided. Assuming Tsys = 30 K&#39;</span>
            <span class="n">Tsys</span> <span class="o">=</span> <span class="mi">30</span> <span class="c1"># Tsys for Arecibo in K</span>

        <span class="n">xarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">has_validProfile</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_noise</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">velMin</span><span class="p">,</span><span class="n">velMax</span><span class="p">,</span>
                            <span class="n">noiseScale</span><span class="o">=</span><span class="n">noiseScale</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_noiseScale</span><span class="p">(</span><span class="n">Tsys</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__calculate_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stats_dict</span><span class="p">,</span> <span class="n">from_init_to</span><span class="o">=</span><span class="s1">&#39;plus&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculates pvalue of fits.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        stats_dict : dict</span>

<span class="sd">        from_init_to : str</span>
<span class="sd">            &#39;plus&#39; for comparing initial to more components</span>
<span class="sd">            &#39;minus&#39; for comparing initial to fewer components</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">ftest</span><span class="p">,</span><span class="n">fvalue</span>

        <span class="k">if</span> <span class="n">from_init_to</span> <span class="ow">is</span> <span class="s1">&#39;plus&#39;</span><span class="p">:</span>
            <span class="n">pvalue_plus</span> <span class="o">=</span> \
                    <span class="n">ftest</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">],</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_plus&#39;</span><span class="p">],</span>
                          <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_init&#39;</span><span class="p">],</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_plus&#39;</span><span class="p">])</span>

            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_plus</span>
        <span class="k">elif</span> <span class="n">from_init_to</span> <span class="ow">is</span> <span class="s1">&#39;minus&#39;</span><span class="p">:</span>
            <span class="n">pvalue_minus</span> <span class="o">=</span> \
                    <span class="n">ftest</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">],</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">],</span>
                          <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_minus&#39;</span><span class="p">],</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_init&#39;</span><span class="p">])</span>

            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_minus</span>

        <span class="k">return</span> <span class="n">stats_dict</span>

    <span class="k">def</span> <span class="nf">__check_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span> <span class="n">grow_pos</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Converts coordinates to grid coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coords : str</span>
<span class="sd">            &#39;grid&#39; or &#39;image&#39;</span>

<span class="sd">        x,y : int</span>
<span class="sd">            x and y positions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x,y : int</span>
<span class="sd">            x and y positions in grid coordinates</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">grow_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">grow_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at grid position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span>
                <span class="nb">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">grow_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grow_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at image position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span>
                <span class="nb">exit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>

    <span class="k">def</span> <span class="nf">__check_number_of_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">number_of_fits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">co_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Checks whether the number_of_fits supplied by the user is valid.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">()):</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_tiles</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">())</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">number_of_fits</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">number_of_fits</span> <span class="o">&gt;</span> <span class="n">total_tiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span> <span class="o">=</span> <span class="n">total_tiles</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__invalid_tile_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span> <span class="o">=</span> <span class="n">total_tiles</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__invalid_tile_count</span>

        <span class="k">return</span> <span class="n">number_of_fits</span>

<div class="viewcode-block" id="SpectralGrid.check_residuals"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.check_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">check_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks tile at x,y, to find any significant peaks in the</span>
<span class="sd">        residuals that should be fitted. Threshold is in units of standard</span>
<span class="sd">        deviations.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">where</span>

        <span class="n">noiseProfile</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_noiseProfile</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span>

        <span class="n">maxResid</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">noiseProfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxResid</span> <span class="o">&gt;=</span> <span class="n">noiseProfile</span><span class="p">[</span><span class="n">maxResid</span> <span class="o">==</span> <span class="n">residuals</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">maxResid</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">[</span><span class="n">where</span><span class="p">(</span><span class="n">residuals</span> <span class="o">==</span> <span class="n">maxResid</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span></div>

    <span class="k">def</span> <span class="nf">__check_zero_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">):</span>
        <span class="c1"># If no fits were significant, then adjust the parameters</span>
        <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_chi2</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="k">def</span> <span class="nf">__check_write_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tile_save_freq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Checks whether or not it is time to write the SpectralGrid instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span><span class="o">%</span><span class="n">tile_save_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Saving SpectralGrid instance as &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">write_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Saving SpectralGrid instance as &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">write_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__choose_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">co_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Determines whether neighboring tile is suitable for fitting.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">returnNeighbor</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># If all conditions satisfied, set to True</span>
        <span class="c1"># Check if tile exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Check if tile is at the boundary</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_boundary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
                <span class="c1"># Check if tile profile has been fit</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Check if tile is in queue already</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">is_visited</span><span class="p">():</span>
                        <span class="c1"># Does the CO tile exist?</span>
                        <span class="k">if</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">imageX</span><span class="p">,</span><span class="n">imageY</span><span class="p">)</span> <span class="o">=</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">grid2image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                            <span class="c1">#hiX,hiY = self.grid2image(x,y)</span>
                            <span class="c1">#COx,COy = co_cube.image2grid(hiX,hiY)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">COncomps</span> <span class="o">=</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">imageY</span><span class="p">,</span>
                                                        <span class="n">imageX</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span>
                                                        <span class="n">coords</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ncomps</span>
                                <span class="c1">#COncomps = co_cube.get_neighbor(COx,</span>
                                <span class="c1">#                        COy,direction).ncomps</span>
                                <span class="k">if</span> <span class="n">COncomps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">returnNeighbor</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                                <span class="n">returnNeighbor</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">returnNeighbor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">returnNeighbor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">set_visited</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__choose_neighbor_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">co_cube</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Chooses next tiles to add to fitting queue.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">random</span>

        <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">,</span><span class="s1">&#39;west&#39;</span><span class="p">,</span><span class="s1">&#39;north&#39;</span><span class="p">,</span><span class="s1">&#39;south&#39;</span><span class="p">,]</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">directions</span><span class="p">):</span>
            <span class="c1"># Check if tile exists</span>
            <span class="n">neighbor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__choose_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                    <span class="n">direction</span><span class="p">,</span><span class="n">co_cube</span> <span class="o">=</span> <span class="n">co_cube</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">neighbor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tile_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_neighbor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tile_ncomp_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tile_param_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__compare_component_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Performs F-test on fits with N, N-1, and N+1 # of model</span>
<span class="sd">        components.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ftest_result : int</span>
<span class="sd">            = +1, Fitting additional component is significant.</span>
<span class="sd">            = 0, Fitting initial components is significant.</span>
<span class="sd">            = -1, Fitting one fewer component is significant.</span>

<span class="sd">        stats_dict : dict</span>
<span class="sd">            Contains the relevant stats.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">ftest</span><span class="p">,</span><span class="n">fvalue</span>

        <span class="c1"># Degrees of freedom = # of data - # of model parameters</span>

        <span class="n">dofInit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">])</span>
        <span class="n">dofMinus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_minus&#39;</span><span class="p">])</span>
        <span class="n">dofPlus</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">])</span>
        <span class="n">chi_init</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span>
        <span class="n">chi_minus</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">]</span>
        <span class="n">chi_plus</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_plus&#39;</span><span class="p">]</span>

        <span class="n">pvalue_plus</span> <span class="o">=</span> <span class="n">ftest</span><span class="p">(</span><span class="n">chi_init</span><span class="p">,</span><span class="n">chi_plus</span><span class="p">,</span><span class="n">dofInit</span><span class="p">,</span><span class="n">dofPlus</span><span class="p">)</span>
        <span class="n">pvalue_minus</span> <span class="o">=</span> <span class="n">ftest</span><span class="p">(</span><span class="n">chi_minus</span><span class="p">,</span><span class="n">chi_init</span><span class="p">,</span><span class="n">dofMinus</span><span class="p">,</span><span class="n">dofInit</span><span class="p">)</span>

        <span class="n">ftest_result</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pvalue_plus</span> <span class="o">&lt;</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="ow">or</span> \
        	<span class="n">pvalue_minus</span> <span class="o">&gt;</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
        	<span class="c1"># Fit more components if significant</span>
            <span class="k">if</span> <span class="n">pvalue_plus</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pvalue_minus</span><span class="p">:</span>
                <span class="n">ftest_result</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
            <span class="c1"># Fit fewer components if significant</span>
            <span class="k">elif</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pvalue_minus</span> <span class="o">&lt;=</span> <span class="n">pvalue_plus</span><span class="p">:</span>
                <span class="n">ftest_result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dofInit</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dofMinus</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dofPlus</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_init</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_plus</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi_minus</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_plus</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue_minus</span>

        <span class="k">return</span> <span class="n">ftest_result</span><span class="p">,</span> <span class="n">stats_dict</span>

    <span class="k">def</span> <span class="nf">__fit_fewer_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># If 1 one less than one component is significant, then 0 components is</span>
        <span class="c1"># significant</span>
        <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;Fewer components significant&#39;</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> \
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_chi2</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;Fewer components significant&#39;</span>

                <span class="n">data_dict</span><span class="p">,</span><span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fit_onemore_component</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;Number of components in fit = &#39;</span> <span class="o">+</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_minus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">())</span>

                <span class="c1"># Calculate p-value</span>
                <span class="n">stats_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_pvalue</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">,</span>
                        <span class="n">from_init_to</span><span class="o">=</span><span class="s1">&#39;minus&#39;</span><span class="p">)</span>

                <span class="c1"># If p-value is still significant, use new tile and</span>
                <span class="c1"># repeat</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">SpectralTile</span><span class="p">(</span><span class="n">tile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_minus&#39;</span><span class="p">])</span>
                <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_minus&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__fit_initial_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Performs the initial fit of a tile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">            Dictionary of parameters used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_dict : dict</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># If there are no components</span>
        <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">noiseProfile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">noiseProfile</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">sum</span><span class="p">((</span><span class="n">profile</span> <span class="o">-</span> <span class="n">noiseProfile</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">noiseProfile</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># If there are components, then fit the profile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">],</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">],</span>
                <span class="n">co_tile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_tile&#39;</span><span class="p">],</span>
                <span class="n">co_width_scale</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_width_scale&#39;</span><span class="p">])</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_chi2</span><span class="p">()</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visited</span><span class="p">()</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;param_init&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span>

    <span class="k">def</span> <span class="nf">__fit_onefewer_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Performs the initial fit of a tile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">            Dictionary of parameters used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_dict : dict</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># First create a temporary tile</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpectralTile</span><span class="p">(</span><span class="n">tile</span> <span class="o">=</span>\
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Calculate the chi^2</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">noiseProfile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">noiseProfile</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">sum</span><span class="p">((</span><span class="n">profile</span> <span class="o">-</span> <span class="n">noiseProfile</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">noiseProfile</span><span class="p">)</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_minus&#39;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Create initial guesses</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__write_to_list</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>

            <span class="c1"># Perform the fit</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_minus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_minus&#39;</span><span class="p">],</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">co_tile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_tile&#39;</span><span class="p">],</span>
                <span class="n">co_width_scale</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_width_scale&#39;</span><span class="p">])</span>

            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_minus&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_minus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_chi2</span><span class="p">()</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span>

    <span class="k">def</span> <span class="nf">__fit_onemore_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Performs fit with additional component of a tile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">            Dictionary of parameters used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        stats_dict : dict</span>
<span class="sd">            Dictionary of statistics used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">        stats_dict : dict</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">gaussFitting</span> <span class="kn">import</span> <span class="n">guess_width</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SpectralTile</span><span class="p">(</span><span class="n">tile</span> <span class="o">=</span> \
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">])</span>
        <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_chi2</span><span class="p">()</span>

        <span class="n">peak_residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_residuals</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">peak_residual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> \
                        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">profile</span>
            <span class="c1"># Guess next component parameters</span>
            <span class="n">guesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__write_to_list</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">])</span>
            <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_residual</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak_residual</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_width</span><span class="p">(</span><span class="n">tile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">],</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">peak_residual</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">spectral_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>
            <span class="n">guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guesses</span>

            <span class="c1"># Perform fit</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                    <span class="n">guesses</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">],</span>
                    <span class="n">ncomp</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">co_tile</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_tile&#39;</span><span class="p">],</span>
                    <span class="n">co_width_scale</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_width_scale&#39;</span><span class="p">])</span>

            <span class="c1"># Adjust tile and statistics</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">params</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_chi2</span><span class="p">()</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;ncomp_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ncomps</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;dof_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span> \
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_number_of_params</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_plus&#39;</span><span class="p">])</span>

        <span class="c1"># If not residuals are above noise*threshold, then do not fit</span>
        <span class="k">elif</span> <span class="n">peak_residual</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_plus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;chi_init&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span>

    <span class="k">def</span> <span class="nf">__fit_more_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Performs tile fits with additional components until the fits are</span>
<span class="sd">        no longer significant.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">            Dictionary of parameters used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        stats_dict : dict</span>
<span class="sd">            Dictionary of statistics used for fitting. See the fit_profiles</span>
<span class="sd">            function for further details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">        stats_dict : dict</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_zero_fits</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Additional components significant.&#39;</span>

            <span class="n">data_dict</span><span class="p">,</span><span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fit_onemore_component</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Number of components in fit = &#39;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_plus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">())</span>

            <span class="c1"># Calculate p-value</span>
            <span class="n">stats_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_pvalue</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">)</span>

            <span class="n">veryverbose</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">veryverbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;pvalue = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pvalue_plus&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="SpectralGrid.fit_profiles"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.fit_profiles">[docs]</a>    <span class="k">def</span> <span class="nf">fit_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guesses</span><span class="o">=</span><span class="p">[],</span> <span class="n">ncomp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grow_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tile_save_freq</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_fits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">outputFilename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">co_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">co_width_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                    <span class="n">veryverbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Fits spectral axis for each pixel in the cube.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guesses : list</span>
<span class="sd">            Default = [0,0,0]</span>
<span class="sd">            1D List of length ncomp * 3</span>
<span class="sd">            Contains initial guesses for the gaussian fits.</span>
<span class="sd">            Format: [shift,amplitude,width,shift,amplitude,width]</span>

<span class="sd">        ncomp : int</span>
<span class="sd">            Default = 1</span>
<span class="sd">            Number of gaussian components to fit.</span>

<span class="sd">        grow_pos : tuple</span>
<span class="sd">            2D tuple consisting of (x,y) positions for grow method to begin</span>
<span class="sd">            fitting</span>

<span class="sd">        coords : string, optional</span>
<span class="sd">            Default = &#39;grid&#39;</span>
<span class="sd">            Either &#39;grid&#39; or &#39;image&#39; coordinates.</span>

<span class="sd">        alpha : float, optional</span>
<span class="sd">            Default = 0.05</span>
<span class="sd">            1 - alpha = confidence for F-test</span>
<span class="sd">            Rather, p-values below alpha are considered significant</span>

<span class="sd">        filename : string, optional</span>
<span class="sd">            Name of file to save SpectralGrid instance to.</span>

<span class="sd">        tile_save_freq : int, optional</span>
<span class="sd">            After tile_save_freq number of tiles fit, the SpectralGrid instance</span>
<span class="sd">            will</span>
<span class="sd">            be saved to filename.</span>

<span class="sd">        threshold : float, optional</span>
<span class="sd">            Default = 1</span>
<span class="sd">            When fitting additional components, only allow residuals to be</span>
<span class="sd">            considered significant if amplitude &gt; threshold * noise in channel.</span>

<span class="sd">        verbose : boolean, optional</span>
<span class="sd">            Default = True</span>

<span class="sd">        outputFilename : string, optional</span>
<span class="sd">            Default is no output file will be written.</span>

<span class="sd">        co_cube : SpectralGrid</span>
<span class="sd">            SpectralGrid instance of a CO on the same spatial grid as the input</span>
<span class="sd">            HI cube. Fitted profiles in the CO cube will be used to guesses</span>
<span class="sd">            where HI absorption is present in the HI cube. Channels in the HI</span>
<span class="sd">            cube with HI absorption will be excluded from a profile fit.</span>

<span class="sd">        co_width_scale : float</span>
<span class="sd">            Scalar of the CO velocity width.</span>



<span class="sd">            # Fitting begins:</span>
<span class="sd">            # Steps to take:</span>
<span class="sd">            # Perform fit with previous pixel&#39;s parameters as initial guesses</span>
<span class="sd">            # Perform fit with same parameters -</span>
<span class="sd">                # parameters for smallest gaussian</span>
<span class="sd">                # Calculate p-value between 1st and 2nd fits</span>
<span class="sd">            # Perform fit with previous pixels&#39;s parameters as intial guesses +</span>
<span class="sd">                # guess from highest residual</span>
<span class="sd">                # Calculate p-value betwen 1st and 3rd fits</span>
<span class="sd">            # If p-value is signifcant, choose fit with smaller p-value</span>
<span class="sd">            # Continue performing f-test with</span>
<span class="sd">                # either fewer components or more components</span>
<span class="sd">                # until p-value is insignificant.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">Queue</span> <span class="kn">as</span> <span class="nn">queue</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">f</span>
        <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">ftest</span><span class="p">,</span><span class="n">fvalue</span>
        <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span>
        <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="nb">exit</span>
        <span class="kn">from</span> <span class="nn">agpy.gaussfitter</span> <span class="kn">import</span> <span class="n">multigaussfit</span> <span class="k">as</span> <span class="n">gfit</span>
        <span class="kn">import</span> <span class="nn">random</span>

        <span class="c1"># Set number of fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">__check_number_of_fits</span><span class="p">(</span><span class="n">number_of_fits</span> <span class="o">=</span> <span class="n">number_of_fits</span><span class="p">,</span>
                        <span class="n">co_cube</span> <span class="o">=</span> <span class="n">co_cube</span><span class="p">)</span>

        <span class="c1"># Convert coordinates to grid if image / set default</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_coords</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span><span class="n">grow_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Initial positions: x = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, y = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="c1"># Initialize arrays and counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tile_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tile_param_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ncomp_init&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;params_init&#39;</span><span class="p">:</span> <span class="n">guesses</span><span class="p">,</span>
                <span class="s1">&#39;params_minus&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;params_plus&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;co_tile&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;co_width_scale&#39;</span><span class="p">:</span> <span class="n">co_width_scale</span><span class="p">,</span>
                <span class="s1">&#39;tile_init&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;tile_minus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;tile_plus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="n">stats_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dof_init&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;dof_minus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;dof_plus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;chi_init&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;chi_plus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;chi_minus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;pvalue_plus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;pvalue_minus&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Beginning fit #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tile_fit_limit</span><span class="p">))</span>

            <span class="c1"># Get the next tile and the corresponding guesses</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;params_init&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__get_next_tile</span><span class="p">()</span>

            <span class="c1"># Get the positions of the tile</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_position</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Get the CO tile</span>
            <span class="k">if</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;co_tile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Fitting tile at Grid position &#39;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;Fitting tile at Image position &#39;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid2image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                            <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid2image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Perform fit with initial # of components</span>
            <span class="c1"># ----------------------------------------</span>
            <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fit_initial_components</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

            <span class="c1"># Perform fit with one fewer components</span>
            <span class="c1"># -------------------------------------</span>
            <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fit_onefewer_component</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

            <span class="c1"># Perform fit with an additional component</span>
            <span class="c1"># ----------------------------------------</span>
            <span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__fit_onemore_component</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

            <span class="c1"># Perform F-test on three fits</span>
            <span class="c1"># ----------------------------</span>
            <span class="n">ftest_result</span><span class="p">,</span> <span class="n">stats_dict</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">__compare_component_fits</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span><span class="n">stats_dict</span><span class="p">)</span>

            <span class="c1"># Perform fits with more components</span>
            <span class="c1"># ---------------------------------</span>
            <span class="k">if</span> <span class="n">ftest_result</span> <span class="o">==</span> <span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fit_more_components</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

            <span class="c1"># Perform fits with fewer components</span>
            <span class="c1"># ----------------------------------</span>
            <span class="k">if</span> <span class="n">ftest_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__fit_fewer_components</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span>
                        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

            <span class="c1"># Were any fits successful? If not, write it to the tile</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_zero_fits</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">)</span>

            <span class="c1"># Write best-fit tile to the grid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Tile at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; fitted with &#39;</span> <span class="o">+</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;tile_init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ncomps</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; components&#39;</span>

            <span class="c1"># Write grid to file?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__check_write_grid</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="n">tile_save_freq</span> <span class="o">=</span> <span class="n">tile_save_freq</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># Now add new tiles to list</span>
            <span class="c1"># MUST randomize directions so that initial conditions do not</span>
            <span class="c1">#   affect the output!!!!!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__choose_neighbor_tiles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">co_cube</span> <span class="o">=</span> <span class="n">co_cube</span><span class="p">,</span>
                    <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="c1"># Tile finished, add to count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Write out final grid</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">write_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralGrid.fit_profile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.fit_profile">[docs]</a>    <span class="k">def</span> <span class="nf">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">guesses</span><span class="p">,</span><span class="n">ncomp</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span><span class="n">co_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">co_width_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fits gaussians to a pixel in the cube.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert coordinates to grid if image / set default</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at image position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span>
                <span class="nb">exit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">co_cube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">co_tile</span> <span class="o">=</span> <span class="n">co_cube</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">co_tile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                                           <span class="n">guesses</span><span class="o">=</span><span class="n">guesses</span><span class="p">,</span>
                                           <span class="n">ncomp</span><span class="o">=</span><span class="n">ncomp</span><span class="p">,</span>
                                           <span class="n">co_tile</span><span class="o">=</span><span class="n">co_tile</span><span class="p">,</span>
                                           <span class="n">co_width_scale</span><span class="o">=</span><span class="n">co_width_scale</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralGrid.get_component"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_component">[docs]</a>    <span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">compNumber</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a gaussian component from a fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tile</span><span class="o">.</span><span class="n">make_component</span><span class="p">(</span><span class="n">compNumber</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralGrid.get_imagexsize"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_imagexsize">[docs]</a>    <span class="k">def</span> <span class="nf">get_imagexsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span></div>

<div class="viewcode-block" id="SpectralGrid.get_imageysize"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_imageysize">[docs]</a>    <span class="k">def</span> <span class="nf">get_imageysize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__get_number_of_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">number_of_params</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
                    <span class="n">number_of_params</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">number_of_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                	<span class="n">number_of_params</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
        	<span class="n">number_of_params</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">number_of_params</span>

<div class="viewcode-block" id="SpectralGrid.get_neighbor"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_neighbor">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighbor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets a neighboring tile East, West, North, or South of the</span>
<span class="sd">        reference tile. The North-West corner of the grid has coordinates</span>
<span class="sd">        (x,y) = (0,0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert coordinates to grid if image / set default</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> get_neighbor: Tile at image position &#39;</span> \
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not exist.&#39;</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="s1">&#39;south&#39;</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">yNeighbor</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yNeighbor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="s1">&#39;north&#39;</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">():</span>
            <span class="n">yNeighbor</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yNeighbor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="s1">&#39;west&#39;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xNeighbor</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">xNeighbor</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="s1">&#39;east&#39;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">():</span>
            <span class="n">xNeighbor</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">xNeighbor</span><span class="p">,</span><span class="n">y</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__get_next_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the next tile in the tile queue.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">tile_copy</span> <span class="o">=</span> <span class="n">SpectralTile</span><span class="p">(</span><span class="n">tile</span> <span class="o">=</span> <span class="n">tile</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">guesses</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">__write_to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tile_param_queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">guesses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tile_param_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;No further profiles to fit.&#39;</span>

        <span class="k">return</span> <span class="n">tile_copy</span><span class="p">,</span> <span class="n">guesses</span>

<div class="viewcode-block" id="SpectralGrid.get_spectral_axis"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_spectral_axis">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the spectral axis of the cube.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span></div>

<div class="viewcode-block" id="SpectralGrid.get_tile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_tile">[docs]</a>    <span class="k">def</span> <span class="nf">get_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a tile at position x,y.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x,y : int</span>
<span class="sd">            Positions</span>
<span class="sd">        coords : string</span>
<span class="sd">            Default = &#39;grid&#39;</span>
<span class="sd">            Either &#39;grid&#39; or &#39;image&#39; coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at grid position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at image position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Tile at image position &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s1">&#39; does not exist.&#39;</span></div>

<div class="viewcode-block" id="SpectralGrid.get_xsize"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_xsize">[docs]</a>    <span class="k">def</span> <span class="nf">get_xsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[:])</span></div>

<div class="viewcode-block" id="SpectralGrid.get_ysize"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.get_ysize">[docs]</a>    <span class="k">def</span> <span class="nf">get_ysize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="SpectralGrid.grid2image"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.grid2image">[docs]</a>    <span class="k">def</span> <span class="nf">grid2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gridXPos</span><span class="p">,</span><span class="n">gridYPos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts grid positions to image pixel positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">gridXPos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gridYPos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="SpectralGrid.guess_width"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.guess_width">[docs]</a>    <span class="k">def</span> <span class="nf">guess_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peak</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">spectral_axis</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Guesses the width of a residual peak.</span>
<span class="sd">        maxpos : int</span>
<span class="sd">            In velocity units.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">where</span>

        <span class="n">residuals</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span>
        <span class="c1"># Find position in array of maximum velocity position</span>
        <span class="n">maxgridpos</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">spectral_axis</span> <span class="o">==</span> <span class="n">peak</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Find amplitude of maximum residual</span>
        <span class="n">maxResid</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">]</span>
        <span class="c1"># Define width as maxpos minus position where residual is 0.5 maxpos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">minPoses</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxResid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">widthPos</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">minPoses</span><span class="p">)</span> <span class="o">-</span> <span class="n">maxgridpos</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spectral_axis</span><span class="p">[</span><span class="n">widthPos</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">spectral_axis</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">minPoses</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">maxgridpos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxResid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">widthPos</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">minPoses</span><span class="p">)</span> <span class="o">-</span> <span class="n">maxgridpos</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span> <span class="o">-</span> <span class="n">spectral_axis</span><span class="p">[</span><span class="n">widthPos</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">spectral_axis</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">width</span></div>

<div class="viewcode-block" id="SpectralGrid.image2grid"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.image2grid">[docs]</a>    <span class="k">def</span> <span class="nf">image2grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imageXPos</span><span class="p">,</span><span class="n">imageYPos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts image positions to grid pixel positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">imageXPos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imageYPos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="SpectralGrid.pix2image"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralGrid.pix2image">[docs]</a>    <span class="k">def</span> <span class="nf">pix2image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pixXPos</span><span class="p">,</span><span class="n">pixYPos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts grid positions to image pixel positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raAxis</span><span class="p">[</span><span class="n">pixXPos</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">decAxis</span><span class="p">[</span><span class="n">pixYPos</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__set_tile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tile</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Writes a tile to the grid_list.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_list</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span>

    <span class="k">def</span> <span class="nf">__write_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list of lists as a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">newList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If the inputList is a lists of lists, then make it a list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inputList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">inputList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">inputList</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">newList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputList</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inputList</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
            	<span class="n">newList</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newList</span> <span class="o">=</span> <span class="n">inputList</span>

        <span class="k">return</span> <span class="n">newList</span></div>


<div class="viewcode-block" id="SpectralTile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile">[docs]</a><span class="k">class</span> <span class="nc">SpectralTile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Subclass of Tile.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">guesses</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ncomps</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">gridXPos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">gridYPos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">imageXPos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">imageYPos</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">xOffset</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">yOffset</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">noiseProfile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">compAreaList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fit_chi2</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">fValuePlusList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fValueMinusList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spectral_axis</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">coVelocities</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gridXPos</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="n">gridYPos</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">imageXPos</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">imageYPos</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">profile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">tile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">box</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a tile use a pyspeckit Cube instance.</span>

<span class="sd">        tile : SpectralTile</span>
<span class="sd">            Copies parameters from input tile to new tile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

        <span class="k">if</span> <span class="n">tile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guesses</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridXPos</span> <span class="o">=</span> <span class="n">gridXPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridYPos</span> <span class="o">=</span> <span class="n">gridYPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageXPos</span> <span class="o">=</span> <span class="n">imageXPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageYPos</span> <span class="o">=</span> <span class="n">imageYPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xOffset</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yOffset</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Copy tile parameters to new tile</span>
        <span class="k">if</span> <span class="n">tile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">guesses</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">guesses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">residuals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">visited</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">fitSuccess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">noise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">noiseProfile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compAreaList</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_chi2</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">fit_chi2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridXPos</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">gridXPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gridYPos</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">gridYPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageXPos</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">imageXPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageYPos</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">imageYPos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xOffset</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">yOffset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yOffset</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">xOffset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fValuePlusList</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">fValuePlusList</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fValueMinusList</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">fValueMinusList</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">spectral_axis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coVelocities</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">coVelocities</span>

<div class="viewcode-block" id="SpectralTile.calculate_compArea"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.calculate_compArea">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_compArea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">compNumber</span><span class="p">,</span><span class="n">spectral_axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Caclutes area under gaussian.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">spectral_axis</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">spectral_axis</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compParams</span><span class="p">(</span><span class="n">compNumber</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">quad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="SpectralTile.calculate_compAreaList"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.calculate_compAreaList">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_compAreaList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spectral_axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates areas of gaussian components in profile fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">compAreaList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
            <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_compArea</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">spectral_axis</span><span class="p">)</span>
            <span class="n">compAreaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compAreaList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">compAreaList</span><span class="p">)</span>

        <span class="n">tempParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Sort gaussian parameters by area</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">compAreaList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">compAreaList</span><span class="p">)[</span><span class="n">i</span><span class="p">])]</span>
            <span class="n">tempParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">tempParams</span></div>

    <span class="k">def</span> <span class="nf">calculate_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xarr</span><span class="p">,</span><span class="n">lowrange</span><span class="p">,</span><span class="n">highrange</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates rms noise of Tile profile given velocity ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">velMin</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">velMax</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">std</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">velMin</span><span class="p">)):</span>
                <span class="n">noiseRegion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xarr</span> <span class="o">&gt;=</span> <span class="n">velMin</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> \
                                <span class="p">(</span><span class="n">xarr</span> <span class="o">&lt;=</span> <span class="n">velMax</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()[</span><span class="n">noiseRegion</span><span class="p">])</span> <span class="o">+</span> <span class="n">std</span>

            <span class="n">std</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">velMin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">std</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

<div class="viewcode-block" id="SpectralTile.calculate_noiseScale"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.calculate_noiseScale">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_noiseScale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Tsys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates an array for scaling the noise by (Tsys + Tb) / Tsys</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_validProfile</span><span class="p">():</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">Tb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
                <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tsys</span> <span class="o">+</span> <span class="n">Tb</span><span class="p">)</span> <span class="o">/</span> <span class="n">Tsys</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span> <span class="o">=</span> <span class="n">n</span></div>

<div class="viewcode-block" id="SpectralTile.fit_profile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.fit_profile">[docs]</a>    <span class="k">def</span> <span class="nf">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">guesses</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ncomp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">co_tile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">co_width_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform a gaussian decomposition on the profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">agpy.gaussfitter</span> <span class="kn">import</span> <span class="n">multigaussfit</span> <span class="k">as</span> <span class="n">gfit</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">where</span><span class="p">,</span><span class="n">zeros</span><span class="p">,</span><span class="n">linspace</span><span class="p">,</span><span class="n">array</span><span class="p">,</span><span class="n">unique</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">concatenate</span> <span class="k">as</span> <span class="n">concat</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">guesses</span> <span class="o">=</span> <span class="n">guesses</span>
        <span class="c1"># define mask for spectral axis</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Determine extent of CO</span>
        <span class="k">if</span> <span class="n">co_tile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">co_tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">co_tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#vels = zeros(len(co_tile.params))</span>
                <span class="c1">#widths = zeros(len(co_tile.params))</span>
                <span class="c1">## Get velocities and widths of components</span>
                <span class="c1">#for i in range(len(co_tile.params)):</span>
                <span class="c1">#    vels[i] = co_tile.params[i][1]</span>
                <span class="c1">#    widths[i] = co_tile.params[i][2]</span>
                <span class="n">vels</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">widths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">co_tile</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">co_tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">co_tile</span><span class="o">.</span><span class="n">noise</span><span class="p">:</span>
                        <span class="n">vels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co_tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co_tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">vels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vels</span><span class="p">)</span>
                <span class="n">widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">widths</span><span class="p">)</span>
                <span class="c1"># lower and higher velocity extent of components:</span>
                <span class="n">minVels</span> <span class="o">=</span> <span class="n">vels</span> <span class="o">-</span> <span class="n">co_width_scale</span><span class="o">*</span><span class="n">widths</span>
                <span class="n">maxVels</span> <span class="o">=</span> <span class="n">vels</span> <span class="o">+</span> <span class="n">co_width_scale</span><span class="o">*</span><span class="n">widths</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coVelocities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">velpos</span> <span class="o">=</span> <span class="n">array</span><span class="p">([])</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">minVels</span><span class="p">)):</span>
                    <span class="c1"># Define pixels excluded from CO region</span>
                    <span class="n">velpos_temp</span> <span class="o">=</span> <span class="n">where</span><span class="p">((</span><span class="n">spectral_axis</span> <span class="o">&gt;</span> <span class="n">minVels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> \
                                        <span class="p">(</span><span class="n">spectral_axis</span> <span class="o">&lt;</span> <span class="n">maxVels</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">mask</span><span class="p">[</span><span class="n">velpos_temp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="c1"># Define velocities included in CO region</span>
                    <span class="n">coVels</span> <span class="o">=</span> <span class="n">spectral_axis</span><span class="p">[(</span><span class="n">spectral_axis</span> <span class="o">&gt;</span> <span class="n">minVels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> \
                                          <span class="p">(</span><span class="n">spectral_axis</span> <span class="o">&lt;</span> <span class="n">maxVels</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coVelocities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coVels</span><span class="p">)</span>

                <span class="c1"># now determine unique pixels</span>
                <span class="c1"># velpos = unique(velpos).astype(int)</span>
                <span class="c1"># Remove profile pixels within CO region</span>
                <span class="n">xarray</span> <span class="o">=</span> <span class="n">spectral_axis</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">noiseProfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xarray</span> <span class="o">=</span> <span class="n">spectral_axis</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
                <span class="n">noiseProfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span>
                <span class="n">velpos</span><span class="o">=</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xarray</span> <span class="o">=</span> <span class="n">spectral_axis</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
            <span class="n">noiseProfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span>
            <span class="n">velpos</span><span class="o">=</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>

        <span class="c1"># Fit the profile</span>
        <span class="k">if</span> <span class="n">guesses</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># force high amplitude guesses to a threshold</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">guesses</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">guesses</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="n">guesses</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">gfit</span><span class="p">(</span><span class="n">xarray</span><span class="p">,</span>
                    <span class="n">profile</span><span class="p">,</span>
                    <span class="n">ngauss</span><span class="o">=</span><span class="n">ncomp</span><span class="p">,</span>
                    <span class="n">err</span><span class="o">=</span><span class="n">noiseProfile</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guesses</span><span class="p">,</span>
                    <span class="n">limitedmin</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">]</span><span class="o">*</span><span class="n">ncomp</span><span class="p">,</span>
                    <span class="n">limitedmax</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">]</span><span class="o">*</span><span class="n">ncomp</span><span class="p">,</span>
                    <span class="n">minpars</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">maxpars</span><span class="o">=</span><span class="p">[</span><span class="mf">1.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Set class variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tempParams</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_chi2</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectral_axis</span> <span class="o">=</span> <span class="n">spectral_axis</span>

            <span class="c1"># Write gaussian component parameters to Tile, ignore comps with</span>
            <span class="c1"># amp=0 or width=0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tempParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">*</span> <span class="mf">0.</span> \
                        <span class="ow">and</span> <span class="n">tempParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_compAreaList</span><span class="p">(</span><span class="n">spectral_axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralTile.gaussian"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.gaussian">[docs]</a>    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">amp</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns gaussian with amp, shift, width, at position x.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">amp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">width</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="SpectralTile.get_chi2"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_chi2">[docs]</a>    <span class="k">def</span> <span class="nf">get_chi2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_chi2</span></div>

<div class="viewcode-block" id="SpectralTile.get_compAreaList"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_compAreaList">[docs]</a>    <span class="k">def</span> <span class="nf">get_compAreaList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compAreaList</span></div>

<div class="viewcode-block" id="SpectralTile.get_compParams"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_compParams">[docs]</a>    <span class="k">def</span> <span class="nf">get_compParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">compNumber</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extracts parameters of fit from compNumber.</span>
<span class="sd">        Parameters are returned as a list in the format:</span>
<span class="sd">        [amplitude,shift,width]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compNumber</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Number of components in spectrum is &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;Please choose a valid component.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">compNumber</span><span class="p">]</span></div>

<div class="viewcode-block" id="SpectralTile.get_guesses"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_guesses">[docs]</a>    <span class="k">def</span> <span class="nf">get_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">guesses</span></div>

<div class="viewcode-block" id="SpectralTile.get_ncomps"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_ncomps">[docs]</a>    <span class="k">def</span> <span class="nf">get_ncomps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns number of components in a fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span></div>

<div class="viewcode-block" id="SpectralTile.get_noise"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_noise">[docs]</a>    <span class="k">def</span> <span class="nf">get_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span></div>

<div class="viewcode-block" id="SpectralTile.get_noiseProfile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_noiseProfile">[docs]</a>    <span class="k">def</span> <span class="nf">get_noiseProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noiseProfile</span></div>

<div class="viewcode-block" id="SpectralTile.get_params"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span></div>

<div class="viewcode-block" id="SpectralTile.get_position"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a tuple of the x and y position of the Tile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gridXPos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gridYPos</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralTile.get_profile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_profile">[docs]</a>    <span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span></div>

<div class="viewcode-block" id="SpectralTile.get_residuals"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">get_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns residuals.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals</span></div>

<div class="viewcode-block" id="SpectralTile.get_componentVelocities"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.get_componentVelocities">[docs]</a>    <span class="k">def</span> <span class="nf">get_componentVelocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns velocities of components.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">vels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
            <span class="n">vels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vels</span></div>

<div class="viewcode-block" id="SpectralTile.has_validProfile"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.has_validProfile">[docs]</a>    <span class="k">def</span> <span class="nf">has_validProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines whether a profile exists for the tile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="SpectralTile.is_fitSuccessful"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.is_fitSuccessful">[docs]</a>    <span class="k">def</span> <span class="nf">is_fitSuccessful</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns whether the tile profile fit was successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitSuccess</span></div>

<div class="viewcode-block" id="SpectralTile.is_visited"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.is_visited">[docs]</a>    <span class="k">def</span> <span class="nf">is_visited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns whether a gaussian has been fit to the tile profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visited</span></div>

<div class="viewcode-block" id="SpectralTile.make_component"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.make_component">[docs]</a>    <span class="k">def</span> <span class="nf">make_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">compNumber</span><span class="p">,</span><span class="n">spectral_axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a component using fit parameters.</span>
<span class="sd">        Returns a 1D numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Warning: Fit has not been performed, </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                <span class="s1">&#39; or fit has failed. </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                <span class="s1">&#39; No parameters are available.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">compNumber</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">compNumber</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">compNumber</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gaussian</span><span class="p">(</span><span class="n">spectral_axis</span><span class="p">,</span><span class="n">amp</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">width</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralTile.make_gaussian"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.make_gaussian">[docs]</a>    <span class="k">def</span> <span class="nf">make_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xarr</span><span class="p">,</span><span class="n">amp</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates a gaussian shape over across an axis using gaussian</span>
<span class="sd">        parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">gaussArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xarr</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xarr</span><span class="p">):</span>
            <span class="n">gaussArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amp</span><span class="p">,</span><span class="n">shift</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gaussArray</span></div>

<div class="viewcode-block" id="SpectralTile.set_noise"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.set_noise">[docs]</a>    <span class="k">def</span> <span class="nf">set_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">noise</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets noise of profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span></div>

<div class="viewcode-block" id="SpectralTile.set_visited"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.set_visited">[docs]</a>    <span class="k">def</span> <span class="nf">set_visited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the Tile as visited.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visited</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="SpectralTile.subtract_baseline"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.subtract_baseline">[docs]</a>    <span class="k">def</span> <span class="nf">subtract_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xarr</span><span class="p">,</span><span class="n">lowrange</span><span class="p">,</span><span class="n">highrange</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Subtracts a first-degree polynomial baseline from the profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">polyfit</span>

        <span class="n">tempProfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>

        <span class="n">fitRegion</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">velMin</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">velMax</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">velMin</span><span class="p">)):</span>
            <span class="n">tempRegion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xarr</span> <span class="o">&gt;=</span> <span class="n">velMin</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> \
                    <span class="p">(</span><span class="n">xarr</span> <span class="o">&lt;=</span> <span class="n">velMax</span><span class="p">[</span><span class="n">k</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tempRegion</span><span class="p">)):</span>
                <span class="n">fitRegion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempRegion</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">m</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">xarr</span><span class="p">[</span><span class="n">fitRegion</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="n">fitRegion</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">tempProfile</span> <span class="o">-</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">xarr</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpectralTile.calculate_noise"><a class="viewcode-back" href="../docs_rst/grid.html#grid.SpectralTile.calculate_noise">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xarr</span><span class="p">,</span><span class="n">lowrange</span><span class="p">,</span><span class="n">highrange</span><span class="p">,</span><span class="n">noiseScale</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculates rms noise of Tile profile given velocity ranges.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">noiseScale</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">noiseScale</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">std</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">velMin</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">velMax</span> <span class="o">=</span> <span class="p">[</span><span class="n">lowrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">highrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">velMin</span><span class="p">)):</span>
                <span class="n">noiseRegion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xarr</span> <span class="o">&gt;=</span> <span class="n">velMin</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> \
                                <span class="p">(</span><span class="n">xarr</span> <span class="o">&lt;=</span> <span class="n">velMax</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()[</span><span class="n">noiseRegion</span><span class="p">])</span> <span class="o">+</span> <span class="n">std</span>

            <span class="n">std</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">velMin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">noiseScale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span></div></div>


<span class="c1">################################################################################</span>
<span class="c1"># Functions</span>
<span class="c1">################################################################################</span>

<div class="viewcode-block" id="compare_grids"><a class="viewcode-back" href="../docs_rst/grid.html#grid.compare_grids">[docs]</a><span class="k">def</span> <span class="nf">compare_grids</span><span class="p">(</span><span class="n">grid0</span><span class="p">,</span> <span class="n">grid1</span><span class="p">,</span> <span class="n">velocityrange</span><span class="o">=</span><span class="p">[],</span> <span class="n">plotallpixels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Plots heat map of N(HI) residuals between SpectralGrid instances</span>
<span class="sd">    between grid0 and grid1. The two SpectralGrids must be on the same</span>
<span class="sd">    coordinate grid.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">kapteyn</span> <span class="kn">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">kwcs</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">velocityrange</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">grid0</span><span class="o">.</span><span class="n">spectral_axis</span>
        <span class="n">velocityrange</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">imagegrid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">grid0</span><span class="o">.</span><span class="n">header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Grid0</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">grid0</span><span class="o">.</span><span class="n">get_imagexsize</span><span class="p">(),</span><span class="n">grid0</span><span class="o">.</span><span class="n">get_imageysize</span><span class="p">()))</span>
    <span class="n">image</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">grid0</span><span class="o">.</span><span class="n">region</span>
    <span class="n">tilecount</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">grid0</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vel</span> <span class="o">&lt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">vel</span> <span class="o">&gt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">tilecount</span> <span class="o">=</span> <span class="n">tilecount</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">NHIimage0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.823e-2</span>

    <span class="c1"># Grid1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">grid1</span><span class="o">.</span><span class="n">get_imagexsize</span><span class="p">(),</span><span class="n">grid1</span><span class="o">.</span><span class="n">get_imageysize</span><span class="p">()))</span>
    <span class="n">image</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">region</span>
    <span class="n">tilecount</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">grid1</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
                    <span class="n">vel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">vel</span> <span class="o">&lt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">vel</span> <span class="o">&gt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">tilecount</span> <span class="o">=</span> <span class="n">tilecount</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">NHIimage1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.823e-2</span>

    <span class="c1"># Define plot properties</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">imagegrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk4&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotallpixels</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">grid0</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grid0</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">grid0</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">grid0</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1">#cmap = plt.cm.get_cmap(&#39;rainbow&#39;,NHIimage.max()-NHIimage.min()+1)</span>
    <span class="c1">#cmap = ax.cm.get_cmap(&#39;gray&#39;)</span>
    <span class="c1">#cmap.set_bad(&#39;w&#39;,1.)</span>
    <span class="c1">#ax.imshow(NHIimage, interpolation=&#39;nearest&#39;,cmap=cmap,origin=&#39;lower&#39;)    #cbar = ax.colorbar()</span>
    <span class="c1">#cbar.set_label(r&#39;N(H\,\textsc{i}) $\times$ 10$^{18}$ cm$^{-2}$&#39;)</span>


    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NHIimage0</span> <span class="o">-</span> <span class="n">NHIimage1</span><span class="p">,</span>
                   <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                   <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;N(H\,\textsc{i}) $\times$ 10$^{20}$ cm$^{-2}$&#39;</span><span class="p">,</span>
                   <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
                   <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="display_image"><a class="viewcode-back" href="../docs_rst/grid.html#grid.display_image">[docs]</a><span class="k">def</span> <span class="nf">display_image</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">plotallpixels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">imagegrid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="c1">#label_mode=&#39;L&#39;,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">imagegrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk4&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>

    <span class="c1">#cmap = plt.cm.get_cmap(&#39;rainbow&#39;,NHIimage.max()-NHIimage.min()+1)</span>
    <span class="c1">#cmap = ax.cm.get_cmap(&#39;gray&#39;)</span>
    <span class="c1">#cmap.set_bad(&#39;w&#39;,1.)</span>
    <span class="c1">#ax.imshow(NHIimage, interpolation=&#39;nearest&#39;,cmap=cmap,origin=&#39;lower&#39;)    #cbar = ax.colorbar()</span>
    <span class="c1">#ax.rc(&#39;text&#39;, usetex=True)</span>
    <span class="c1">#ax.rc(&#39;font&#39;, family=&#39;serif&#39;)</span>
    <span class="c1">#cbar.set_label(r&#39;N(H\,\textsc{i}) $\times$ 10$^{18}$ cm$^{-2}$&#39;)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;bunit&#39;</span><span class="p">],</span>
                   <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
                   <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="guess_width"><a class="viewcode-back" href="../docs_rst/grid.html#grid.guess_width">[docs]</a><span class="k">def</span> <span class="nf">guess_width</span><span class="p">(</span><span class="n">tile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">peak</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">spectral_axis</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Guesses the width of a residual peak.</span>
<span class="sd">    maxpos : int</span>
<span class="sd">        In velocity units.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">where</span>

    <span class="n">residuals</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span>
    <span class="c1"># Find position in array of maximum velocity position</span>
    <span class="n">maxgridpos</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">spectral_axis</span> <span class="o">==</span> <span class="n">maxpos</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Find amplitude of maximum residual</span>
    <span class="n">maxResid</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">]</span>
    <span class="c1"># Define width as maxpos minus position where residual is 0.5 maxpos</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">minPoses</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxResid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">widthPos</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">minPoses</span><span class="p">)</span> <span class="o">-</span> <span class="n">maxgridpos</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spectral_axis</span><span class="p">[</span><span class="n">widthPos</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">spectral_axis</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">minPoses</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">maxgridpos</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">maxResid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">widthPos</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">minPoses</span><span class="p">)</span> <span class="o">-</span> <span class="n">maxgridpos</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span> <span class="o">-</span> <span class="n">spectral_axis</span><span class="p">[</span><span class="n">widthPos</span><span class="p">]</span> <span class="o">+</span> \
                <span class="n">spectral_axis</span><span class="p">[</span><span class="n">maxgridpos</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">width</span></div>


<div class="viewcode-block" id="load_grid"><a class="viewcode-back" href="../docs_rst/grid.html#grid.load_grid">[docs]</a><span class="k">def</span> <span class="nf">load_grid</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Loads saved SpectralGrid instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">load</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;/SpectralGrid&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">SpectralGrid</span> <span class="o">=</span> <span class="n">tile</span><span class="o">=</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;/grid_list&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">grid_list</span> <span class="o">=</span> <span class="n">tile</span><span class="o">=</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SpectralGrid</span></div>

<div class="viewcode-block" id="make_velocityAxis"><a class="viewcode-back" href="../docs_rst/grid.html#grid.make_velocityAxis">[docs]</a><span class="k">def</span> <span class="nf">make_velocityAxis</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates the velocity axis given a header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">arange</span>

    <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">array</span> <span class="o">/</span> <span class="mf">1000.</span></div>

<div class="viewcode-block" id="make_radecAxes"><a class="viewcode-back" href="../docs_rst/grid.html#grid.make_radecAxes">[docs]</a><span class="k">def</span> <span class="nf">make_radecAxes</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Creates the RA and Dec axis given a header.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">arange</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ra</span><span class="p">,</span><span class="n">dec</span></div>

<div class="viewcode-block" id="plot_NHI"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_NHI">[docs]</a><span class="k">def</span> <span class="nf">plot_NHI</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">velocityrange</span><span class="o">=</span><span class="p">[],</span> <span class="n">plotallpixels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
             <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">returnimage</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">kapteyn</span> <span class="kn">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">kwcs</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">velocityrange</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">spectral_axis</span>
        <span class="n">velocityrange</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">imagegrid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">get_imagexsize</span><span class="p">(),</span><span class="n">grid</span><span class="o">.</span><span class="n">get_imageysize</span><span class="p">()))</span>
    <span class="n">image</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">region</span>
    <span class="n">tilecount</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
                    <span class="n">lowVel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">highVel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">highVel</span> <span class="o">&lt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">lowVel</span> <span class="o">&gt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">tilecount</span> <span class="o">=</span> <span class="n">tilecount</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1">#print tilecount</span>

    <span class="n">NHIimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.823e-2</span>

    <span class="c1">#NHIimage[NHIimage == NHIimage.max()] = 1</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">imagegrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk4&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotallpixels</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>


    <span class="c1">#cmap = plt.cm.get_cmap(&#39;rainbow&#39;,NHIimage.max()-NHIimage.min()+1)</span>
    <span class="c1">#cmap = ax.cm.get_cmap(&#39;gray&#39;)</span>
    <span class="c1">#cmap.set_bad(&#39;w&#39;,1.)</span>
    <span class="c1">#ax.imshow(NHIimage, interpolation=&#39;nearest&#39;,cmap=cmap,origin=&#39;lower&#39;)    #cbar = ax.colorbar()</span>
    <span class="c1">#cbar.set_label(r&#39;N(H\,\textsc{i}) $\times$ 10$^{18}$ cm$^{-2}$&#39;)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NHIimage</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;N(H\,\textsc{i}) $\times$ 10$^{20}$ cm$^{-2}$&#39;</span><span class="p">,</span>
                   <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
                   <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnimage</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NHIimage</span></div>

<div class="viewcode-block" id="plot_fit"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_fit">[docs]</a><span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">coRegion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
             <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the components of a gaussian fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="nb">exit</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">noiseProfile</span>
    <span class="c1">#print noise</span>
    <span class="n">xarr</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_spectral_axis</span><span class="p">()</span>
    <span class="n">residualXarr</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">spectral_axis</span>
    <span class="c1">#print residuals.shape</span>
    <span class="c1">#print residualXarr.shape</span>
    <span class="c1">#print len(xarr)</span>
    <span class="n">totGaussFit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xarr</span><span class="p">))</span>
    <span class="n">ncomps</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ncomps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Profile has not been successfully fit for tile&#39;</span>
        <span class="nb">exit</span><span class="p">()</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()):</span>
        <span class="n">tileParams</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">get_compParams</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">tileParams</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">totGaussFit</span> <span class="o">=</span> <span class="n">totGaussFit</span> <span class="o">+</span> <span class="n">comp</span>

    <span class="c1">#residuals = sp - totGaussFit</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">-</span> <span class="n">totGaussFit</span>


    <span class="c1"># Begin plotting</span>
    <span class="k">if</span> <span class="n">coRegion</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">coVelocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">coVels</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">coVelocities</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coVel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coVels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">coVel</span><span class="p">,</span>
                            <span class="o">-</span><span class="mf">1e100</span><span class="p">,</span><span class="mf">1e100</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HI absorption region&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">coVel</span><span class="p">,</span>
                            <span class="o">-</span><span class="mf">1e100</span><span class="p">,</span><span class="mf">1e100</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">residualXarr</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span><span class="s1">&#39;g-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">totGaussFit</span><span class="p">,</span><span class="s1">&#39;y-.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Composite Model Spectrum&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model Component&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Pos: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageXPos</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageYPos</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;# components = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ncomps</span><span class="p">),</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.90</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">residuals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">1.05</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>


    <span class="c1">#from matplotlib.ticker import MultipleLocator</span>
    <span class="c1">#ml = MultipleLocator(5)</span>
    <span class="c1">#ax.xaxis.set_minor_locator(ml)</span>
    <span class="c1">#ax.xaxis.get_ticklines(minor=True)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T$_b$ (K)&#39;</span><span class="p">)</span>

    <span class="c1"># Plot residuals:</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">residAx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">residAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">residAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">noise</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">residAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="o">-</span><span class="n">noise</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">residuals</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">noise</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">residuals</span><span class="o">.</span><span class="n">min</span><span class="p">():</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">noise</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">miny</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">residAx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.1</span><span class="o">*</span><span class="n">miny</span><span class="p">,</span><span class="mf">1.1</span><span class="o">*</span><span class="n">maxy</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">residAx</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T$_b$ (K)&#39;</span><span class="p">)</span>

    <span class="c1"># Plot noise array:</span>
    <span class="n">Tsys</span> <span class="o">=</span> <span class="mf">30.</span> <span class="c1"># Assume for Arecibo</span>
    <span class="n">Tb</span> <span class="o">=</span> <span class="n">sp</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tsys</span> <span class="o">+</span> <span class="n">Tb</span><span class="p">)</span> <span class="o">/</span> <span class="n">Tsys</span>
    <span class="c1">#divider2 = make_axes_locatable(residAx)</span>
    <span class="n">noiseAx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">noiseAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">noise</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">noiseAx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">noiseAx</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\eta_{eff}$&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # Plot noise array - residuals:</span>
<span class="sd">    noiseScale = residuals * noise</span>
<span class="sd">    noiseScaleAx = divider.append_axes(&quot;bottom&quot;, size=1.2, pad=0.1, sharex=ax)</span>
<span class="sd">    noiseScaleAx.plot(xarr,noiseScale, &#39;k&#39;,label=&#39;Scaled Residuals&#39;)</span>
<span class="sd">    noiseScaleAx.plot(xarr,residuals, &#39;g&#39;,label=&#39;Raw Residuals&#39;)</span>
<span class="sd">    plt.legend(loc=&#39;upper right&#39;)</span>
<span class="sd">    noiseScaleAx.set_ylim(noiseScale.min() - 1,noiseScale.max() + 1)</span>
<span class="sd">    plt.ylabel(&#39;T$_b$ (K)&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>



    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xarr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">xarr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="c1">#plt.ylim(residuals.min() - 5, sp.max() + 5)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km/s)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_fits"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_fits">[docs]</a><span class="k">def</span> <span class="nf">plot_fits</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">xlist</span><span class="p">,</span><span class="n">ylist</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">coRegion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the components of a gaussian fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="nb">exit</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">Grid</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">plotGrid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">),</span>
                 <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlist</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ylist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

        <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">noiseProfile</span>
        <span class="n">xarr</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_spectral_axis</span><span class="p">()</span>
        <span class="n">totGaussFit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xarr</span><span class="p">))</span>
        <span class="n">ncomps</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ncomps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Profile has not been successfully fit for tile&#39;</span>
            <span class="nb">exit</span><span class="p">()</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plotGrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()):</span>
            <span class="n">tileParams</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">get_compParams</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">tileParams</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">comp</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">totGaussFit</span> <span class="o">=</span> <span class="n">totGaussFit</span> <span class="o">+</span> <span class="n">comp</span>

        <span class="n">residuals</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">-</span> <span class="n">totGaussFit</span>

        <span class="k">if</span> <span class="n">coRegion</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">coVelocities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">coVels</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">coVelocities</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">coVels</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">1e100</span><span class="p">,</span><span class="mf">1e100</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HI absorption region&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">totGaussFit</span><span class="p">,</span><span class="s1">&#39;y-.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Composite Model Spectrum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model Component&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Pos: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageXPos</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> \
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageYPos</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;# components = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ncomps</span><span class="p">),</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.90</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">residuals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">1.05</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>


        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xarr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">xarr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T$_b$ (K)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km/s)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_ncompImage"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_ncompImage">[docs]</a><span class="k">def</span> <span class="nf">plot_ncompImage</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">plotallpixels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">kapteyn</span> <span class="kn">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">kwcs</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">imagegrid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">ncompImage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">get_imagexsize</span><span class="p">(),</span><span class="n">grid</span><span class="o">.</span><span class="n">get_imageysize</span><span class="p">()))</span>
    <span class="n">ncompImage</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">region</span>
    <span class="n">tilecount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ncompImage</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span>
                <span class="n">tilecount</span> <span class="o">=</span> <span class="n">tilecount</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncompImage</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ncompImage</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ncompImage</span><span class="p">))</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    cmap = plt.cm.get_cmap(&#39;rainbow&#39;,image.max()-image.min()+1)</span>
<span class="sd">    cmap.set_bad(&#39;w&#39;,1.)</span>
<span class="sd">    plt.imshow(image, interpolation=&#39;nearest&#39;,cmap=cmap,origin=&#39;lower&#39;)</span>
<span class="sd">    plt.colorbar()</span>
<span class="sd">    plt.show()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">imagegrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="c1">#ax.set_ticklabel_type(&quot;hms&quot;, &quot;dms&quot;)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotallpixels</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>


    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;# of components&#39;</span><span class="p">,</span>
                   <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
                   <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_componentPV"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_componentPV">[docs]</a><span class="k">def</span> <span class="nf">plot_componentPV</span><span class="p">(</span><span class="n">SpectralGrid</span><span class="p">,</span><span class="n">xslice</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">yslice</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">grid_list</span>

    <span class="k">if</span> <span class="n">xslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;nothing&#39;</span>
    <span class="k">if</span> <span class="n">yslice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SpectralGrid</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">()):</span>
                <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">yslice</span> <span class="o">+</span> <span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">vels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">())</span>
                    <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">)):</span>
                        <span class="n">vel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">vel</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">vel</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="n">vels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel</span>
                            <span class="n">areas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>

                    <span class="c1">#velocities = tile.get_componentVelocities()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vels</span><span class="p">),</span><span class="n">vels</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)],</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">areas</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km $s^{-1}$)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_residualsImage"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_residualsImage">[docs]</a><span class="k">def</span> <span class="nf">plot_residualsImage</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">plotallpixels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">kapteyn</span> <span class="kn">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">kwcs</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">imagegrid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">residImage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">grid</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">(),</span><span class="n">grid</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">()))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">residImage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">residImage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">residImage</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">get_residuals</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">residImage</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">imagegrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="c1">#ax.set_ticklabel_type(&quot;hms&quot;, &quot;dms&quot;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination (J2000)&#39;</span><span class="p">,</span>
              <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span>
              <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotallpixels</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">grid</span><span class="o">.</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;# of components&#39;</span><span class="p">,</span>
                   <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span>
                   <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_spectrum"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_spectrum">[docs]</a><span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the components of a gaussian fit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="nb">exit</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">image2grid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="n">tile</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">noiseProfile</span>
    <span class="n">xarr</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_spectral_axis</span><span class="p">()</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model Component&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Pos: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageXPos</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">imageYPos</span><span class="p">),</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.90</span><span class="p">),</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.95</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">1.05</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>


    <span class="c1">#from matplotlib.ticker import MultipleLocator</span>
    <span class="c1">#ml = MultipleLocator(5)</span>
    <span class="c1">#ax.xaxis.set_minor_locator(ml)</span>
    <span class="c1">#ax.xaxis.get_ticklines(minor=True)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T$_b$ (K)&#39;</span><span class="p">)</span>

    <span class="c1"># Plot noise array:</span>
    <span class="n">Tsys</span> <span class="o">=</span> <span class="mf">30.</span> <span class="c1"># Assume for Arecibo</span>
    <span class="n">Tb</span> <span class="o">=</span> <span class="n">sp</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tsys</span> <span class="o">+</span> <span class="n">Tb</span><span class="p">)</span> <span class="o">/</span> <span class="n">Tsys</span>
    <span class="c1">#divider2 = make_axes_locatable(residAx)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">noiseAx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">noiseAx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span><span class="n">noise</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">noiseAx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">noise</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="n">noise</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">noiseAx</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\eta_{eff}$&#39;</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # Plot noise array - residuals:</span>
<span class="sd">    noiseScale = residuals * noise</span>
<span class="sd">    noiseScaleAx = divider.append_axes(&quot;bottom&quot;, size=1.2, pad=0.1, sharex=ax)</span>
<span class="sd">    noiseScaleAx.plot(xarr,noiseScale, &#39;k&#39;,label=&#39;Scaled Residuals&#39;)</span>
<span class="sd">    noiseScaleAx.plot(xarr,residuals, &#39;g&#39;,label=&#39;Raw Residuals&#39;)</span>
<span class="sd">    plt.legend(loc=&#39;upper right&#39;)</span>
<span class="sd">    noiseScaleAx.set_ylim(noiseScale.min() - 1,noiseScale.max() + 1)</span>
<span class="sd">    plt.ylabel(&#39;T$_b$ (K)&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>



    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xarr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">xarr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="c1">#plt.ylim(residuals.min() - 5, sp.max() + 5)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km/s)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_velocityHistograms"><a class="viewcode-back" href="../docs_rst/grid.html#grid.plot_velocityHistograms">[docs]</a><span class="k">def</span> <span class="nf">plot_velocityHistograms</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="n">velocityList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">grid</span><span class="o">.</span><span class="n">get_xsize</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">grid</span><span class="o">.</span><span class="n">get_ysize</span><span class="p">()):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
            <span class="n">ncomps</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">get_ncomps</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ncomps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomps</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">100</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">velocityList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">velocityArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">velocityList</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">velocityArray</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">velocityArray</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">velocityList</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity (km/s)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="write_grid"><a class="viewcode-back" href="../docs_rst/grid.html#grid.write_grid">[docs]</a><span class="k">def</span> <span class="nf">write_grid</span><span class="p">(</span><span class="n">SpectralGrid</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Writes grid_list to file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">dump</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">system</span><span class="p">,</span><span class="n">path</span>

    <span class="n">save</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">save</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39; Folder exists, SpectralGrid will be saved under as &#39;</span> <span class="o">+</span> \
                   <span class="n">filename</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">save</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39; File exists, SpectralGrid will not be saved.&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;/grid_list&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">dump</span><span class="p">(</span><span class="n">SpectralGrid</span><span class="o">.</span><span class="n">grid_list</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;/SpectralGrid&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">dump</span><span class="p">(</span><span class="n">SpectralGrid</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="write_fits_NHI"><a class="viewcode-back" href="../docs_rst/grid.html#grid.write_fits_NHI">[docs]</a><span class="k">def</span> <span class="nf">write_fits_NHI</span><span class="p">(</span><span class="n">SpectralGrid</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">velocityrange</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&#39;&#39;&#39; Calculates the column density of the SpectralGrid model profiles and</span>
<span class="sd">    writes as a fits file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># External modules</span>
    <span class="kn">import</span> <span class="nn">pyfits</span> <span class="kn">as</span> <span class="nn">pf</span>

    <span class="c1"># Use all velocities if not specified</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">velocityrange</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">spectral_axis</span>
        <span class="n">velocityrange</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">sp</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">sp</span><span class="p">)]</span>

    <span class="c1"># Choose components</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">SpectralGrid</span><span class="o">.</span><span class="n">get_imagexsize</span><span class="p">(),</span>
        <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">get_imageysize</span><span class="p">()))</span>
    <span class="n">image</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">region</span>
    <span class="n">tilecount</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">tile</span> <span class="o">=</span> <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">get_tile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile</span><span class="o">.</span><span class="n">ncomps</span><span class="p">):</span>
                    <span class="n">lowVel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">highVel</span> <span class="o">=</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">highVel</span> <span class="o">&lt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">lowVel</span> <span class="o">&gt;</span> <span class="n">velocityrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                        <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tile</span><span class="o">.</span><span class="n">compAreaList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">tilecount</span> <span class="o">=</span> <span class="n">tilecount</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">NHIimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.823e-2</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">SpectralGrid</span><span class="o">.</span><span class="n">header</span>
    <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">hdu</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">NHIimage</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">custom_modules 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Elijah Bernstein-Cooper.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>