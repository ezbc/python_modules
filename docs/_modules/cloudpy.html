<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cloudpy &mdash; custom_modules 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="custom_modules 0.0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">custom_modules 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cloudpy</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python -W ignore::DeprecationWarning</span>

<span class="c1"># Import external modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Module Classes</span>

<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="Cloud"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.Cloud">[docs]</a><span class="k">class</span> <span class="nc">Cloud</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">av_filename</span><span class="p">,</span>
            <span class="n">hi_filename</span><span class="p">,</span>
            <span class="n">av_error_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">hi_error_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">mask_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">cloud_prop_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">dgr_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">intercept_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">width_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">threshold_delta_dgr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
            <span class="n">residual_width_scale</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
            <span class="n">av_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">av_background</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">clobber_likelihoods</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">likelihood_filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">hi_noise_vel_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">binsize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">vel_range_diff_thres</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="n">init_vel_width</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">vel_center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">vel_center_gauss_fit_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">subtract_comps</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">recalculate_likelihoods</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">pixel_mask_increase_fraction</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">diagnostic_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">use_bin_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">use_only_binned_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">bin_procedure</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="n">binned_data_filename_ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">weights_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">av_mask_threshold</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">plot_args</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">perform_parent_iterations</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="p">):</span>

        <span class="c1"># Import external modules</span>
        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
        <span class="c1">#import pyfits as fits</span>
        <span class="kn">from</span> <span class="nn">mycoords</span> <span class="kn">import</span> <span class="n">make_velocity_axis</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">system</span><span class="p">,</span><span class="n">path</span>

        <span class="c1"># Define local variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span> <span class="o">=</span> <span class="n">av_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename</span> <span class="o">=</span> <span class="n">hi_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename</span> <span class="o">=</span> <span class="n">av_error_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_filename</span> <span class="o">=</span> <span class="n">hi_error_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_filename</span> <span class="o">=</span> <span class="n">mask_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error</span> <span class="o">=</span> <span class="n">av_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dgr_grid</span> <span class="o">=</span> <span class="n">dgr_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_grid</span> <span class="o">=</span> <span class="n">width_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intercept_grid</span> <span class="o">=</span> <span class="n">intercept_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">THRESHOLD_DELTA_DGR</span> <span class="o">=</span> <span class="n">threshold_delta_dgr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RESIDUAL_WIDTH_SCALE</span> <span class="o">=</span> <span class="n">residual_width_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clobber_likelihoods</span> <span class="o">=</span> <span class="n">clobber_likelihoods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_likelihoods</span> <span class="o">=</span> <span class="n">recalculate_likelihoods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">likelihood_filename</span> <span class="o">=</span> <span class="n">likelihood_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_noise_vel_range</span> <span class="o">=</span> <span class="n">hi_noise_vel_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">binsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="o">=</span><span class="n">use_bin_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_only_binned_data</span><span class="o">=</span><span class="n">use_only_binned_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_procedure</span><span class="o">=</span><span class="n">bin_procedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tsys</span> <span class="o">=</span> <span class="mf">30.0</span> <span class="c1"># K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VEL_RANGE_DIFF_THRES</span> <span class="o">=</span> <span class="n">vel_range_diff_thres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_vel_width</span> <span class="o">=</span> <span class="n">init_vel_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">=</span> <span class="n">vel_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtract_comps</span> <span class="o">=</span> <span class="n">subtract_comps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span> <span class="o">=</span> <span class="n">plot_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_filename</span> <span class="o">=</span> <span class="n">diagnostic_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PIXEL_MASK_INCREASE_FRACTION</span> <span class="o">=</span> <span class="n">pixel_mask_increase_fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_data_filename_ext</span> <span class="o">=</span> <span class="n">binned_data_filename_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights_filename</span> <span class="o">=</span> <span class="n">weights_filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_mask_threshold</span> <span class="o">=</span> <span class="n">av_mask_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_parent_iterations</span> <span class="o">=</span> <span class="n">perform_parent_iterations</span>

        <span class="c1"># Initialize empty variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data_bin</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># Load data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">av_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">hi_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">av_error_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header</span> <span class="o">=</span> \
                    <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">av_error_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">av_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">av_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">hi_error_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">hi_error_filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_header</span> <span class="o">=</span> \
                <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">hi_error_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">cloud_prop_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_cloud_properties</span><span class="p">(</span><span class="n">cloud_prop_filename</span><span class="p">)</span>

        <span class="c1"># Use only binned data throughout the analysis?</span>
        <span class="c1"># Either load the binned images or create new images</span>
        <span class="c1">#if self.use_only_binned_data:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_procedure</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_bin_filenames</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">binned_data_filename_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">load_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_files</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
                <span class="n">write_data</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">load_data</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">write_data</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">load_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bin_data</span><span class="p">(</span><span class="n">write_data</span><span class="o">=</span><span class="n">write_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_bin_data</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">av_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">av_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header_bin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_filename_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename</span>

        <span class="c1"># Background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_background</span> <span class="o">=</span> <span class="n">av_background</span>
        <span class="k">if</span> <span class="n">av_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">-</span> <span class="n">av_background</span>

        <span class="c1"># Make velocity axis for HI cube</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span> <span class="o">=</span> <span class="n">make_velocity_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel_center_gauss_fit_kwargs</span> <span class="o">=</span> <span class="n">vel_center_gauss_fit_kwargs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">sys</span>
            <span class="kn">import</span> <span class="nn">os</span>

            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing output to </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_filename</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_filename</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostic_filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_load_bin_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
        <span class="c1">#import pyfits as fits</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Loading binned data...&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span> <span class="o">=</span> \
                <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_filename_bin</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header_bin</span> <span class="o">=</span> \
                <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span> <span class="o">=</span> \
                <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span> <span class="o">=</span> \
                    <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights_filename</span><span class="p">)</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">existing</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">alltrue</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_bin_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_data_filename_ext</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_filename_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ext</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ext</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_error&#39;</span> <span class="o">+</span> <span class="n">ext</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="n">ext</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">av_filename_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span><span class="p">,]</span>

    <span class="k">def</span> <span class="nf">_calc_vel_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hi_data</span><span class="p">,</span> <span class="n">single_vel_center</span><span class="o">=</span><span class="mi">1</span><span class="p">,):</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmedian</span>

        <span class="k">if</span> <span class="n">single_vel_center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span> <span class="o">=</span> \
                    <span class="n">nanmedian</span><span class="p">(</span><span class="n">hi_data</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">vel_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                   <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="o">**</span><span class="mi">2</span><span class="p">),))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vel_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Using array of HI velocity centers...&#39;</span><span class="p">)</span>
            <span class="n">vel_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span> <span class="o">=</span> <span class="n">hi_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">vel_center</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                    <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="o">**</span><span class="mi">2</span><span class="p">),))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vel_center</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">=</span> <span class="n">vel_center</span>

    <span class="k">def</span> <span class="nf">_calc_vel_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gauss_fit_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmedian</span>
        <span class="kn">from</span> <span class="nn">myfitting</span> <span class="kn">import</span> <span class="n">fit_gaussians</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span> <span class="o">=</span> \
                <span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">[:,</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel_center_fits</span> <span class="o">=</span> <span class="n">fit_gaussians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hi_spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">gauss_fit_kwargs</span><span class="p">)</span>

        <span class="n">amp_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center_fits</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">amp_max</span><span class="p">:</span>
                <span class="n">amp_max</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vel_center</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_comp_num</span> <span class="o">=</span> <span class="n">i</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">=</span> <span class="n">vel_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">width</span><span class="p">,])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_vel_width</span> <span class="o">=</span> <span class="n">width</span>

    <span class="k">def</span> <span class="nf">_subtract_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hi_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vel_center_fits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">cloud_comp_num</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;vel_center_fits&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_comps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hi_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">hi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span>
            <span class="k">if</span> <span class="n">vel_center_fits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">vel_center_fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center_fits</span>
            <span class="k">if</span> <span class="n">cloud_comp_num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cloud_comp_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_comp_num</span>

            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp_fit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vel_center_fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">cloud_comp_num</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">hi_data</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-=</span> <span class="n">comp_fit</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span> <span class="n">comp_fit</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/spectrum.png&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hi_data</span>

    <span class="k">def</span> <span class="nf">_derive_region_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">av_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">mygeometry</span> <span class="kn">as</span> <span class="nn">myg</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">binned</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">av_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">av_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span>
            <span class="c1"># Derive relevant region</span>
            <span class="n">region_vertices</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;poly_verts&#39;</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span>

            <span class="c1"># block off region</span>
            <span class="n">region_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">myg</span><span class="o">.</span><span class="n">get_polygon_mask</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span>
                                                              <span class="n">region_vertices</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span> <span class="o">=</span> <span class="n">region_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">av_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">av_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span>
            <span class="c1"># Derive relevant region</span>
            <span class="n">region_vertices</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;poly_verts_bin&#39;</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span>

            <span class="c1"># block off region</span>
            <span class="n">region_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">myg</span><span class="o">.</span><span class="n">get_polygon_mask</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span>
                                                              <span class="n">region_vertices</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span> <span class="o">=</span> <span class="n">region_mask</span>

    <span class="k">def</span> <span class="nf">_prep_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Derives mask for NaNs and 0 errors.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span><span class="p">)</span> <span class="o">|</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span><span class="p">)</span> <span class="o">|</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image</span><span class="p">)</span> <span class="o">|</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mask_bin</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="p">)</span> <span class="o">|</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span><span class="p">)</span> <span class="o">|</span> \
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image_bin</span><span class="p">)</span> <span class="o">|</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image_bin</span><span class="p">)</span> <span class="o">|</span> \
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image_bin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">binned</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mask_bin</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_derive_bin_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;region_limit_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;region_limit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;plot_limit_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;plot_limit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span> <span class="o">=</span> <span class="n">convert_limit_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">,</span>
                                               <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="p">,</span>
                                               <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;region_limit_bin&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;plot_limit_bin&#39;</span><span class="p">))</span>

        <span class="n">region_vertices</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">][</span><span class="s1">&#39;poly_verts&#39;</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span>

        <span class="c1"># block off region</span>
        <span class="n">region_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">myg</span><span class="o">.</span><span class="n">get_polygon_mask</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span>
                                                          <span class="n">region_vertices</span><span class="p">))</span>

        <span class="n">mask_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_mask</span><span class="p">(</span><span class="n">binned</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pix_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Ra and dec in (hrs,min,sec) and (deg,arcmin,arcsec), or Ra in degrees</span>
<span class="sd">        and dec in degrees.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
        <span class="kn">import</span> <span class="nn">pywcs</span>
        <span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

        <span class="c1"># convert to degrees if ra and dec are array-like</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hrs2degs</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;RA and Dec must be in (hrs,min,sec) and&#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39; (deg,arcmin,arcsec) or in degrees.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span> <span class="o">=</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

        <span class="c1">#wcs_header = pywcs.WCS(header)</span>
        <span class="n">wcs_header</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="c1">#pix_coords = wcs_header.wcs_sky2pix([[ra_deg, dec_deg, 0]], 0)[0]</span>
        <span class="n">pix_coords</span> <span class="o">=</span> <span class="n">wcs_header</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">([[</span><span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span><span class="p">],],</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pix_coords</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_hrs2degs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Ra and dec tuples in hrs min sec and deg arcmin arcsec.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ra_deg</span> <span class="o">=</span> <span class="mi">15</span><span class="o">*</span><span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">60.</span> <span class="o">+</span> <span class="n">ra</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.</span><span class="p">)</span>
        <span class="n">dec_deg</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">60.</span> <span class="o">+</span> <span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">ra_deg</span><span class="p">,</span> <span class="n">dec_deg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;region_limit&#39;</span><span class="p">,</span><span class="s1">&#39;co_noise_limits&#39;</span><span class="p">,</span><span class="s1">&#39;plot_limit&#39;</span><span class="p">),</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Converts WCS coordinates to pixel coordinates for a few sky</span>
<span class="sd">        positions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        header : fits.header</span>
<span class="sd">            If None, then uses self.av_header&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span>

        <span class="c1"># Initialize pixel keys</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pixel&#39;</span><span class="p">:</span> <span class="p">[]})</span>

            <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;region_limit&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;plot_limit&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;region_limit_bin&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;plot_limit_bin&#39;</span><span class="p">):</span>
                <span class="n">limit_wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">limits</span> <span class="ow">in</span> <span class="n">limit_wcs</span><span class="p">:</span>
                    <span class="c1"># convert centers to pixel coords</span>
                    <span class="n">limit_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pix_coords</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">dec</span><span class="o">=</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_pixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_pixels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">coord</span> <span class="o">==</span> <span class="s1">&#39;co_noise_limits&#39;</span><span class="p">:</span>
                <span class="n">region_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">]</span>

                <span class="c1"># Cycle through each region, convert WCS limits to pixels</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">region_limits</span><span class="p">:</span>
                    <span class="n">region_pixels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">limits</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>
                        <span class="c1"># convert centers to pixel coords</span>
                        <span class="n">limit_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pix_coords</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">dec</span><span class="o">=</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">region_pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit_pixels</span><span class="p">)</span>

                    <span class="c1"># Append individual regions back to CO noise</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="n">coord</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_pixels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_model_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel_range_max</span><span class="p">,</span> <span class="n">dgr_max</span><span class="p">,</span> <span class="n">intercept_max</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span>

        <span class="c1"># Calulate chi^2 for best fit models</span>
        <span class="c1"># ----------------------------------</span>
        <span class="n">nhi_image_temp</span> <span class="o">=</span> <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span><span class="p">,</span>
                                       <span class="n">velocity_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                       <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range_max</span><span class="p">,</span>
                                       <span class="n">return_nhi_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_image_model_masked</span> <span class="o">=</span> <span class="n">nhi_image_temp</span> <span class="o">*</span> <span class="n">dgr_max</span> <span class="o">+</span> \
                <span class="n">intercept_max</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_mask</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">av_image_model_masked</span><span class="p">,</span>
                                     <span class="n">nhi_image_temp</span><span class="p">])</span>

        <span class="n">numerator</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">-</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">av_image_model_masked</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">numerator</span><span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>

        <span class="c1">#std = np.nanstd(self.av_data_bin - self.av_image_model_bin)</span>

        <span class="c1"># Derive new av data error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span> <span class="o">=</span> <span class="n">std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;init_likelihood_results&#39;</span><span class="p">][</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">std</span>

    <span class="k">def</span> <span class="nf">_bin_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">av_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">av_error_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">hi_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_data</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span><span class="p">,</span> <span class="n">calculate_noise_cube</span><span class="p">,</span> \
                <span class="n">bin_image</span>
        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

        <span class="k">if</span> <span class="n">av_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">av_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span>
        <span class="k">if</span> <span class="n">av_error_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">av_error_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span>
        <span class="k">if</span> <span class="n">hi_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">hi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Binning data...&#39;</span><span class="p">)</span>

        <span class="c1"># Bin the images, retain only one bin_weight image since they are all</span>
        <span class="c1"># the same</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="n">binsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span>

        <span class="k">def</span> <span class="nf">weighted_mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="n">wmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wmean</span>

        <span class="c1"># Av image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span> <span class="o">=</span> \
                <span class="n">bin_image</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span><span class="c1"># / av_error_data**2,</span>
                          <span class="n">binsize</span><span class="o">=</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span>
                          <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="p">,</span>
                          <span class="c1">#statistic=np.nansum,</span>
                          <span class="n">statistic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span>
                          <span class="n">return_weights</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="c1">#weights=av_error_data,</span>
                          <span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bin_weights</span> <span class="o">=</span> \
                    <span class="n">bin_image</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">av_error_data</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">binsize</span><span class="o">=</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span>
                              <span class="n">statistic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">,</span>
                              <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span> <span class="o">/</span> <span class="n">bin_weights</span>
        <span class="c1">#self.av_data_bin / np.nansum(1. / av_error_data**2)</span>

        <span class="c1"># Av image error</span>
        <span class="c1"># Errors add in square</span>
        <span class="c1"># mean = sum(a_i) / n</span>
        <span class="c1"># error on mean = sqrt(sum(a_i**2 / n**2))</span>
        <span class="c1">#noise_func = lambda x: (np.nansum(x**2) / np.sum(~np.isnan(x)))**0.5</span>
        <span class="c1">#noise_func = lambda x: np.nanstd(x)</span>
        <span class="n">noise_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">x</span><span class="o">**-</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#noise_func = lambda x: np.nansum(x**2)**0.5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header_bin</span> <span class="o">=</span> \
                <span class="n">bin_image</span><span class="p">(</span><span class="n">av_error_data</span><span class="p">,</span>
                          <span class="n">binsize</span><span class="o">=</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span>
                          <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_header</span><span class="p">,</span>
                          <span class="n">statistic</span><span class="o">=</span><span class="n">noise_func</span><span class="p">,)</span>

        <span class="n">av_std</span><span class="p">,</span> <span class="n">av_std_header</span> <span class="o">=</span> \
                <span class="n">bin_image</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span>
                          <span class="n">binsize</span><span class="o">=</span><span class="p">(</span><span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span>
                          <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="p">,</span>
                          <span class="n">statistic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">,)</span>

        <span class="c1">#self.av_error_data_bin = np.sqrt(av_std**2 + self.av_error_data_bin**2</span>
        <span class="c1">#self.av_error_data_bin = np.sqrt(av_std**2 + self.av_error_data_bin**2)</span>

        <span class="c1"># Hi image</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span> <span class="o">=</span> \
                    <span class="n">bin_image</span><span class="p">(</span><span class="n">hi_data</span><span class="p">,</span>
                              <span class="n">binsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span>
                              <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span><span class="p">,</span>
                              <span class="n">statistic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span> <span class="o">=</span> \
                <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">write_data</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_filename_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_bin</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">hi_header_bin</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_filename_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_filename_bin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_bin</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">av_error_header_bin</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="p">:</span>
                <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_filename</span><span class="p">,</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="p">,</span>
                     <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_common_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_iterate_mle_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vel_range</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>
        <span class="c1"># Import module</span>
        <span class="c1"># --------------</span>
        <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span><span class="p">,</span> <span class="n">calculate_noise_cube</span><span class="p">,</span>\
                                     <span class="n">bin_image</span>
        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">system</span><span class="p">,</span><span class="n">path</span>

        <span class="c1"># Prep data</span>
        <span class="c1"># ---------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;vel_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel_range</span>

        <span class="c1"># check if HI error cube present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data</span> <span class="o">=</span> \
                    <span class="n">calculate_noise_cube</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">,</span>
                                    <span class="n">velocity_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                <span class="n">velocity_noise_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_noise_vel_range</span><span class="p">,</span>
                                    <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_header</span><span class="p">,</span>
                                    <span class="n">Tsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tsys</span><span class="p">,</span>
                                    <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_error_filename</span><span class="p">)</span>

        <span class="c1"># Derive mask by excluding correlated residuals</span>
        <span class="c1"># ---------------------------------------------</span>
        <span class="c1"># Derive initial N(HI) image</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image</span> <span class="o">=</span> \
                    <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">,</span>
                                  <span class="n">velocity_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                  <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                                  <span class="n">noise_cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_error_data</span><span class="p">,</span>
                                  <span class="n">velocity_noise_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_noise_vel_range</span><span class="p">,</span>
                                  <span class="n">Tsys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tsys</span><span class="p">,</span>
                                  <span class="n">return_nhi_error</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span> <span class="o">=</span> \
                    <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">,</span>
                                  <span class="n">velocity_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                  <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                                  <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Write iteration step variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;nhi_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;nhi_image_error&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">nhi_error_image</span>

        <span class="c1"># Finally, derive the mask to be used in calculation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_mask_threshold</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_residual_masking</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Apply initial mask to exclude throughout process</span>
            <span class="n">mask_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span>
            <span class="n">mask_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_mask_threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_init</span> <span class="o">+</span> <span class="n">mask_threshold</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0_0&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="c1"># Apply mask to data, then bin data to avoid correlated pixels</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Bin the data</span>
        <span class="c1">#if not self.use_only_binned_data:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_procedure</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bin_data</span><span class="p">(</span><span class="n">av_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                           <span class="n">av_error_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">,</span>
                           <span class="n">hi_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span>
                           <span class="p">)</span>

            <span class="c1"># Write binned filenames</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_bin_filename</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">av_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bin.fits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">av_error_bin_filename</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bin.fits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_bin_filename</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">hi_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bin.fits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_bin_filename</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">hi_error_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_bin.fits&#39;</span><span class="p">)</span>

            <span class="c1"># Remove binned data</span>
            <span class="n">_check_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_bin_filename</span><span class="p">,</span>
                        <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">_check_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_bin_filename</span><span class="p">,</span>
                        <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">_check_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_bin_filename</span><span class="p">,</span>
                        <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">_check_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_error_bin_filename</span><span class="p">,</span>
                        <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image_bin</span> <span class="o">=</span> \
                <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span><span class="p">,</span>
                              <span class="n">velocity_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                              <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                              <span class="p">)</span>

        <span class="c1"># Mask each image to a common mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_mask</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image_bin</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nhi_image_bin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
            <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>

            <span class="c1"># grid helper</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">grid_helper</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">GridHelper</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                         <span class="n">ngrids</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                         <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                         <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                                     <span class="nb">dict</span><span class="p">(</span><span class="n">grid_helper</span><span class="o">=</span><span class="n">grid_helper</span><span class="p">),</span>
                                     <span class="p">),</span>
                         <span class="n">axes_pad</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                         <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                         <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                         <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image_bin</span><span class="p">,</span>
                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;N(HI)&#39;</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">,</span>
                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Av error&#39;</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                <span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Av&#39;</span><span class="p">)</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">+</span> \
                        <span class="s1">&#39;_prelike_map.png&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;av_bin_map_filename_base&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_procedure</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;mle&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;av_bin_map_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="n">plot_av_bin_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">av_data_bin</span><span class="p">,</span>
                            <span class="n">av_header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header</span><span class="p">,</span>
                            <span class="n">av_header_bin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_header_bin</span><span class="p">,</span>
                            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Calculate MLE for parameters with unbinned data</span>
        <span class="c1"># -----------------------------------------------</span>
        <span class="c1">#self._derive_bin_mask()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\t</span><span class="s1">Calculating MLE parameters with initial errors...&#39;</span><span class="p">)</span>

            <span class="c1">#print(np.sum(~np.isnan(self.hi_av_data_masked)))</span>

        <span class="n">results</span> <span class="o">=</span> \
            <span class="n">_calc_likelihoods</span><span class="p">(</span>
                              <span class="n">hi_cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span><span class="p">,</span>
                              <span class="n">av_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                              <span class="n">av_image_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">,</span>
                              <span class="n">hi_vel_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                              <span class="n">width_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width_grid</span><span class="p">,</span>
                              <span class="n">dgr_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgr_grid</span><span class="p">,</span>
                              <span class="n">intercept_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_grid</span><span class="p">,</span>
                              <span class="n">vel_center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span><span class="p">,</span>
                              <span class="n">bin_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span><span class="p">,</span>
                              <span class="n">use_bin_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="p">,</span>
                              <span class="n">likelihood_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">likelihood_filename</span><span class="p">,</span>
                              <span class="n">clobber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clobber_likelihoods</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                              <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;init_likelihood_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>


        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;scaled_likelihood_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">likelihood_filename</span> <span class="o">=</span> \
                    <span class="s1">&#39;/d/bip3/ezbc/perseus/figures/likelihood/&#39;</span> <span class="o">+</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">+</span> <span class="s1">&#39;_likelihood_lee12_init.png&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_final_params</span><span class="p">()</span>

            <span class="n">plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">filename</span><span class="o">=</span><span class="n">likelihood_filename</span><span class="p">,</span>
                                  <span class="p">)</span>

        <span class="c1"># Unpack output of likelihood calculation</span>
        <span class="n">dgr_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;dgr_max&#39;</span><span class="p">]</span>
        <span class="n">intercept_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">]</span>
        <span class="n">vel_range_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;vel_range_max&#39;</span><span class="p">]</span>

        <span class="c1"># Rerun analysis with new error calculated Error should be calculated</span>
        <span class="c1"># across entire image, not just atomic regions, in order to understand</span>
        <span class="c1"># variation in</span>
        <span class="c1"># DGR</span>
        <span class="c1"># ---------------------------------------------------------------------</span>
        <span class="c1"># Calculate new standard deviation, set global variable npix - 2 is the</span>
        <span class="c1"># number of degrees of freedom see equation 15.1.6 in Numerical Recipes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_model_error</span><span class="p">(</span><span class="n">vel_range_max</span><span class="p">,</span> <span class="n">dgr_max</span><span class="p">,</span> <span class="n">intercept_max</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_likelihoods</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\t</span><span class="s1">Calculating MLE parameters with revised &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;errors...&#39;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> \
                <span class="n">_calc_likelihoods</span><span class="p">(</span>
                                  <span class="n">hi_cube</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data_masked</span><span class="p">,</span>
                                  <span class="n">av_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data_masked</span><span class="p">,</span>
                                  <span class="n">av_image_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data_masked</span><span class="p">,</span>
                                  <span class="n">hi_vel_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                  <span class="n">vel_center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span><span class="p">,</span>
                                  <span class="n">bin_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_weights</span><span class="p">,</span>
                                  <span class="n">use_bin_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bin_weights</span><span class="p">,</span>
                                  <span class="n">width_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width_grid</span><span class="p">,</span>
                                  <span class="n">dgr_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgr_grid</span><span class="p">,</span>
                                  <span class="n">intercept_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_grid</span><span class="p">,</span>
                                  <span class="n">likelihood_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">likelihood_filename</span><span class="p">,</span>
                                  <span class="n">clobber</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clobber_likelihoods</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                  <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;scaled_likelihood_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>

        <span class="n">vel_range</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;vel_range_max&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">vel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vel_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">vel_range</span>

    <span class="k">def</span> <span class="nf">_get_faint_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_av_data_available</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_av_data_sorted</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_av_data_available</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_fraction</span> <span class="o">=</span> <span class="n">init_fraction</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span> <span class="o">=</span> \
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_av_data_available</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">init_fraction</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_av_data_sorted</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span><span class="p">]</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_add_pixels_to_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_fraction</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_fraction</span> <span class="o">+=</span> <span class="n">additional_fraction</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_av_data_available</span><span class="o">.</span><span class="n">size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span> <span class="o">=</span> \
                <span class="nb">int</span><span class="p">(</span><span class="n">npix</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_fraction</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span> <span class="o">&gt;=</span> <span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span> <span class="o">=</span> <span class="n">npix</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_av_data_sorted</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_number</span><span class="p">]</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_trim_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_to_trim</span><span class="p">,</span> <span class="n">trim_mask</span><span class="p">,</span> <span class="n">abs_mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_to_trim</span> <span class="o">+</span> <span class="n">trim_mask</span>

        <span class="n">mask</span><span class="p">[</span><span class="n">trim_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">abs_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="n">abs_mask</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_combine_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_parent</span><span class="p">,</span> <span class="n">mask_child</span><span class="p">,</span> <span class="n">child_action</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Mask will be wherever the parent is masked. The child will mask</span>
<span class="sd">         unmasked elements from the parent</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        child_action : str</span>
<span class="sd">            if &#39;add&#39;, then child is added to parent</span>
<span class="sd">            if &#39;subtract&#39; then child is subtracted from parent</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">child_action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">mask_child</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">child_action</span> <span class="o">==</span> <span class="s1">&#39;subtract&#39;</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="o">~</span><span class="n">mask_child</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_iterate_residual_masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        av_model : numpy array</span>
<span class="sd">        mask : numpy array</span>
<span class="sd">        dgr : float</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

        <span class="c1"># Mask out nans</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_mask</span><span class="p">()</span>

        <span class="c1"># Apply initial mask to exclude throughout process</span>
        <span class="n">mask_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_mask</span>
        <span class="k">if</span> <span class="n">mask_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">+=</span> <span class="n">mask_init</span>

        <span class="n">mask_faint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_faint_mask</span><span class="p">()</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_masks</span><span class="p">(</span><span class="n">mask_init</span><span class="p">,</span> <span class="n">mask_faint</span><span class="p">)</span>

        <span class="n">mask_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">av_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">av_image</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/av_init.png&#39;</span><span class="p">)</span>

        <span class="c1"># solve for DGR using linear least squares</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Beginning iterative DGR calculations + masking...&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Using faint masking method&#39;</span><span class="p">)</span>

        <span class="c1"># Iterate masking pixels which are correlated and rederiving a linear</span>
        <span class="c1"># least squares solution for the DGR</span>
        <span class="c1">#----------------------------------------------------------------------</span>
        <span class="n">masking_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">delta_dgr</span> <span class="o">=</span> <span class="mf">1e10</span>
        <span class="n">dgr</span> <span class="o">=</span> <span class="mf">1e10</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">#while delta_dgr &gt; self.THRESHOLD_DELTA_DGR:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">Iteration {0:.0f} results:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">include_intercept</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">include_intercept</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_grid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">include_intercept</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">include_intercept</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">_fit_params</span><span class="p">(</span>
                                  <span class="n">nhi_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                                  <span class="n">av_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_data</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                                  <span class="n">av_image_error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">av_error_data</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                                  <span class="n">include_intercept</span><span class="o">=</span><span class="n">include_intercept</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                                  <span class="p">)</span>

            <span class="c1"># add new pixels</span>
            <span class="n">mask_faint</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_pixels_to_mask</span><span class="p">(</span><span class="n">additional_fraction</span><span class="o">=</span>\
                                            <span class="bp">self</span><span class="o">.</span><span class="n">PIXEL_MASK_INCREASE_FRACTION</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_masks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_faint</span><span class="p">,</span>
                                       <span class="n">child_action</span><span class="o">=</span><span class="s1">&#39;subtract&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_masks</span><span class="p">(</span><span class="n">mask_init</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

            <span class="c1"># Create model with the DGR</span>
            <span class="n">dgr_new</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;dgr_max&#39;</span><span class="p">]</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">]</span>
            <span class="c1">#av_image_model = self.nhi_image * dgr_new + intercept</span>
            <span class="n">av_image_model</span> <span class="o">=</span> <span class="n">_make_av_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nhi_image</span><span class="p">,</span>
                                            <span class="n">dgr_new</span><span class="p">,</span>
                                            <span class="n">intercept</span><span class="p">,</span>
                                            <span class="p">)</span>

            <span class="n">residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_data</span> <span class="o">-</span> <span class="n">av_image_model</span>
            <span class="n">residuals</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># Record variables</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;dgr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgr_new</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intercept</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

            <span class="c1"># Include only residuals which are white noise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
                                         <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;av_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span>
            <span class="n">mask_residuals_new</span><span class="p">,</span> <span class="n">residual_threshold</span><span class="p">,</span> <span class="n">fit_params</span> <span class="o">=</span> \
                <span class="n">_get_residual_mask</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span>
                               <span class="n">residual_width_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESIDUAL_WIDTH_SCALE</span><span class="p">,</span>
                               <span class="n">plot_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">,</span>
                               <span class="c1">#use_GMM=False,</span>
                               <span class="p">)</span>
            <span class="n">mask_residuals</span> <span class="o">=</span> <span class="n">mask_residuals_new</span>

            <span class="c1"># Record variables</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;fit_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_params</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;mask_residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_residuals</span>
            <span class="n">masking_results</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;residual_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">residual_threshold</span>


            <span class="c1"># Derive new mask</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_masks</span><span class="p">(</span><span class="n">mask_residuals</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">npix_new</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Number of non-masked pixels = &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;{0:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npix</span><span class="p">))</span>


            <span class="c1"># Reset while loop conditions</span>
            <span class="n">delta_dgr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dgr</span> <span class="o">/</span> <span class="n">dgr_new</span><span class="p">)</span>
            <span class="n">dgr</span> <span class="o">=</span> <span class="n">dgr_new</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#if (delta_dgr &lt; self.THRESHOLD_DELTA_DGR) | \</span>
                <span class="c1">#   (np.abs(npix - npix_new) &lt;= 1):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">npix</span> <span class="o">-</span> <span class="n">npix_new</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_pixel_fraction</span> <span class="o">&gt;=</span> <span class="mf">0.99</span><span class="p">:</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="n">npix</span> <span class="o">=</span> <span class="n">npix_new</span>


        <span class="c1"># Create model of Av</span>
        <span class="c1">#self.av_model = dgr * self.nhi_image + intercept</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="c1">#self.av_model[self.mask] = np.nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;masking_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">masking_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_write_final_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="c1">#from myimage_analysis import calculate_nhi</span>

        <span class="n">last_iter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1">#props = self.iter_vars[last_iter][&#39;scaled_likelihood_results&#39;]</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">last_iter</span><span class="p">][</span><span class="s1">&#39;scaled_likelihood_results&#39;</span><span class="p">]</span>

        <span class="c1"># Write results to global properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_center_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_max&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;av_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;co_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_max&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_confint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_confint&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;vel_range_confint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_error&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;vel_range_confint&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_confint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_confint&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_confint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_confint&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_center&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_center&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;single_vel_center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_max&#39;</span><span class="p">][</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km/s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_max&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">+</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_max&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
        <span class="c1">#self.props[&#39;hi_velocity_range_conf&#39;] = self.conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_likelihood&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_likelihood&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_likelihood&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_likelihood&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;vel_centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgr_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intercept_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_plot_likelihoods</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>

        <span class="c1"># Plot the likelihoods</span>
        <span class="k">if</span> <span class="s1">&#39;likelihood_filename_base&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">:</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">os</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;likelihood_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> \
                              <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>


                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;likelihood_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

                <span class="n">plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                                      <span class="p">)</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#self.iter_vars[self.iter_step][&#39;scaled_likelihood_results&#39;] = \</span>
                        <span class="c1">#results</span>

                <span class="n">likelihood_filename_base</span> <span class="o">=</span> \
                        <span class="s1">&#39;/d/bip3/ezbc/perseus/figures/likelihood/&#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;perseus_likelihood_lee12_init_&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_final_params</span><span class="p">()</span>

                <span class="n">plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;widths&#39;</span><span class="p">,</span> <span class="s1">&#39;dgrs&#39;</span><span class="p">),</span>
                              <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">returnimage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                              <span class="n">filename</span><span class="o">=</span><span class="n">likelihood_filename_base</span> <span class="o">+</span> <span class="s1">&#39;wd.png&#39;</span><span class="p">,</span>
                              <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                              <span class="p">)</span>
                <span class="n">plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;widths&#39;</span><span class="p">,</span> <span class="s1">&#39;intercepts&#39;</span><span class="p">),</span>
                              <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">returnimage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                              <span class="n">filename</span><span class="o">=</span><span class="n">likelihood_filename_base</span> <span class="o">+</span> <span class="s1">&#39;wi.png&#39;</span><span class="p">,</span>
                              <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                              <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reload_region</span><span class="p">():</span>

        <span class="k">pass</span>

<div class="viewcode-block" id="Cloud.load_cloud_properties"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.Cloud.load_cloud_properties">[docs]</a>    <span class="k">def</span> <span class="nf">load_cloud_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_filename</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">json</span>

        <span class="c1"># Load global properties</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prop_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cloud.load_region"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.Cloud.load_region">[docs]</a>    <span class="k">def</span> <span class="nf">load_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">pyregion</span> <span class="kn">as</span> <span class="nn">pyr</span>

        <span class="c1"># region[0] in following format:</span>
        <span class="c1"># [64.26975, 29.342033333333333, 1.6262027777777777, 3.32575, 130.0]</span>
        <span class="c1"># [ra center, dec center, width, height, rotation angle]</span>

        <span class="n">regions</span> <span class="o">=</span> <span class="n">pyr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">region_filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span>

        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
            <span class="c1"># Cores defined in following format: &#39;tag={L1495A}&#39;</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">comment</span>
            <span class="n">region_name</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text={&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span><span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1"># Format vertices to be 2 x N array</span>
            <span class="n">poly_verts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">coord_list</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">poly_verts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">region</span><span class="o">.</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span>
                                   <span class="n">region</span><span class="o">.</span><span class="n">coord_list</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="n">region_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="n">region_name</span><span class="p">][</span><span class="s1">&#39;poly_verts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="n">region_name</span><span class="p">][</span><span class="s1">&#39;poly_verts&#39;</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">poly_verts</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">av_header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">poly_verts_pix</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly_verts</span><span class="p">)):</span>
                    <span class="n">poly_verts_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">_get_pix_coords</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">poly_verts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">dec</span><span class="o">=</span><span class="n">poly_verts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                 <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;regions&#39;</span><span class="p">][</span><span class="n">region_name</span><span class="p">][</span><span class="s1">&#39;poly_verts&#39;</span><span class="p">][</span><span class="s1">&#39;pixel&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">poly_verts_pix</span></div>

<div class="viewcode-block" id="Cloud.run_analysis"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.Cloud.run_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s1">&#39;california&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_filename</span> <span class="o">=</span> <span class="n">region_filename</span>

        <span class="c1"># Change WCS coords to pixel coords of images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_coordinates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_filename</span> <span class="o">=</span> <span class="n">region_filename</span>

        <span class="c1"># Load cloud division regions from ds9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_region</span><span class="p">(</span><span class="n">region_filename</span><span class="p">)</span>

        <span class="c1"># derive the region mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_derive_region_mask</span><span class="p">()</span>

        <span class="c1"># Derive velocity center</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center_gauss_fit_kwargs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calc_vel_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_vel_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center_gauss_fit_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtract_comps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hi_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtract_comps</span><span class="p">()</span>

        <span class="c1"># Initialize</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">vel_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vel_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_center</span>

        <span class="n">vel_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_vel_width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                     <span class="n">vel_center</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_vel_width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">vel_range_new</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">)</span>
        <span class="n">vel_range_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel_range</span><span class="p">)</span> <span class="o">-</span> \
                                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel_range_new</span><span class="p">)))</span>

        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#while vel_range_diff &gt; self.VEL_RANGE_DIFF_THRES:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Iteration &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">))</span>

            <span class="n">vel_range_new</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_mle_calc</span><span class="p">(</span><span class="n">vel_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                                           <span class="p">)</span>

            <span class="c1"># Write parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_final_params</span><span class="p">()</span>

            <span class="c1"># Check to see if likelihoods should be plotted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_likelihoods</span><span class="p">()</span>

            <span class="c1"># likelihoods data is large, omit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s1">&#39;scaled_likelihood_results&#39;</span><span class="p">][</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span><span class="p">]</span>\
                    <span class="p">[</span><span class="s1">&#39;init_likelihood_results&#39;</span><span class="p">][</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="n">vel_range_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel_range</span><span class="p">)</span> <span class="o">-</span> \
                                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel_range_new</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Vel range old = &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;{0:.1f} to {1:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">vel_range</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Vel range new = &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;{0:.1f} to {1:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">vel_range_new</span><span class="p">))</span>

            <span class="n">vel_range</span> <span class="o">=</span> <span class="n">vel_range_new</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_parent_iterations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vel_range_diff</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">VEL_RANGE_DIFF_THRES</span><span class="p">:</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">iter_step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_mask</span><span class="p">()</span>

        <span class="c1"># Write prints to file?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">sys</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_stdout</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Set to none so class can be pickled</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostics</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_stdout</span> <span class="o">=</span> <span class="bp">None</span></div></div>

<div class="viewcode-block" id="KeyboardInterruptError"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.KeyboardInterruptError">[docs]</a><span class="k">class</span> <span class="nc">KeyboardInterruptError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Module Functions</span></div>

<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">_calc_likelihoods__</span><span class="p">(</span>
        <span class="n">hi_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">hi_vel_axis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">nhi_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">av_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">av_image_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">bin_weights</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">use_bin_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">vel_center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">width_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">dgr_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">intercept_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">plot_results</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">results_filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">return_likelihoods</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">likelihood_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">conf</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span>
        <span class="n">threshold_delta_dgr</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vel_range : tuple</span>
<span class="sd">        Lower and upper bound of HI velocity range in km/s which provides the</span>
<span class="sd">        best likelihoodelated N(HI) distribution with Av.</span>
<span class="sd">    likelihoods : array-like, optional</span>
<span class="sd">        Array of Pearson likelihoodelation coefficients likelihoodesponding to each</span>
<span class="sd">        permutation through the velocity centers and velocity widths.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">calc_symmetric_error</span><span class="p">,</span> <span class="n">calc_logL</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>

    <span class="c1"># Check if likelihood grid should be derived</span>
    <span class="k">if</span> <span class="n">likelihood_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">):</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># If no filename provided, do not read file and do not write file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">perform_mle</span><span class="p">:</span>
        <span class="c1"># calculate the likelihoodelation coefficient for each velocity</span>
        <span class="c1"># range</span>
        <span class="k">if</span> <span class="n">width_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">width_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dgr_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dgr_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intercept_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">intercept_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">width_grid</span><span class="p">),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">)))</span>

        <span class="c1"># Progress bar parameters</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">likelihoods</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image_error</span><span class="p">,</span>
                       <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/resid.png&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">nhi_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Remove nans</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">av_image</span> <span class="o">!=</span> <span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">av_image_error</span> <span class="o">!=</span> <span class="n">av_image_error</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">av_image_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">nhi_image</span> <span class="o">!=</span> <span class="n">nhi_image</span><span class="p">))</span>

            <span class="n">av_image</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">av_image_error</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">nhi_image</span> <span class="o">=</span> <span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use_bin_weights</span> <span class="ow">and</span> <span class="n">bin_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">bin_weights</span> <span class="o">=</span> <span class="n">bin_weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">print_vel_range</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c1"># Cycle through DGR to estimate error</span>
            <span class="n">width_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">vel_width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">width_grid</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">):</span>
                        <span class="c1"># Create model of Av with N(HI) and DGR</span>
                        <span class="n">av_image_model</span> <span class="o">=</span> <span class="n">nhi_image</span> <span class="o">*</span> <span class="n">dgr</span> <span class="o">+</span> <span class="n">intercept</span>

                        <span class="n">logL</span> <span class="o">=</span> <span class="n">calc_logL</span><span class="p">(</span><span class="n">av_image_model</span><span class="p">,</span>
                                         <span class="n">av_image</span><span class="p">,</span>
                                         <span class="n">data_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                         <span class="p">)</span>

                        <span class="c1">#print logL</span>
                        <span class="n">likelihoods</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">logL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_vel_range</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c1"># Remove nans</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_bin_weights</span><span class="p">:</span>
                <span class="n">hi_cube</span><span class="p">[</span><span class="n">hi_cube</span> <span class="o">!=</span> <span class="n">hi_cube</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">av_image</span> <span class="o">!=</span> <span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
                        <span class="p">(</span><span class="n">av_image_error</span> <span class="o">!=</span> <span class="n">av_image_error</span><span class="p">)</span> <span class="o">|</span> \
                        <span class="p">(</span><span class="n">av_image_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

                <span class="n">av_image</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">av_image_error</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">hi_cube</span> <span class="o">=</span> <span class="n">hi_cube</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># Weight images</span>
            <span class="c1">#bin_weights = None</span>
            <span class="k">if</span> <span class="n">use_bin_weights</span> <span class="ow">and</span> <span class="n">bin_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">av_image</span><span class="p">,</span> <span class="n">av_image_error</span><span class="p">,</span> <span class="n">hi_cube</span> <span class="o">=</span> \
                    <span class="n">_prep_weighted_data</span><span class="p">(</span><span class="n">av_image</span><span class="o">=</span><span class="n">av_image</span><span class="p">,</span>
                                        <span class="n">av_image_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                        <span class="n">hi_cube</span><span class="o">=</span><span class="n">hi_cube</span><span class="p">,</span>
                                        <span class="n">weights</span><span class="o">=</span><span class="n">bin_weights</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">vel_width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">width_grid</span><span class="p">):</span>
                <span class="c1"># Construct N(HI) image outside of DGR loop, then apply</span>
                <span class="c1"># dgr_grid in loop</span>

                <span class="n">vel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">vel_width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                      <span class="n">vel_center</span> <span class="o">+</span> <span class="n">vel_width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>

                <span class="n">nhi_image</span> <span class="o">=</span> <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="n">hi_cube</span><span class="p">,</span>
                                          <span class="n">velocity_axis</span><span class="o">=</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                          <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                                          <span class="n">return_nhi_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                <span class="c1"># Cycle through DGR to estimate error</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">):</span>
                        <span class="c1"># Create model of Av with N(HI) and DGR</span>
                        <span class="n">av_image_model</span> <span class="o">=</span> <span class="n">nhi_image</span> <span class="o">*</span> <span class="n">dgr</span> <span class="o">+</span> <span class="n">intercept</span>

                        <span class="n">logL</span> <span class="o">=</span> <span class="n">calc_logL</span><span class="p">(</span><span class="n">av_image_model</span><span class="p">,</span>
                                         <span class="n">av_image</span><span class="p">,</span>
                                         <span class="n">data_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                         <span class="p">)</span>

                        <span class="c1">#print logL</span>

                        <span class="n">likelihoods</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">logL</span>

    <span class="c1"># Load file of likelihoods</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">perform_mle</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Reading likelihood grid file:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">)</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">)</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">width_grid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
           <span class="nb">len</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified parameter grid not the same as in&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;loaded data likelihoods.&#39;</span><span class="p">)</span>

        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">likelihoods</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="p">))</span>

    <span class="c1"># Normalize the log likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Convert to likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">likelihoods</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Normalize the likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">likelihoods</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1">#print width_grid</span>
    <span class="c1">#print dgr_grid</span>
    <span class="c1">#print intercept_grid</span>
    <span class="c1">#print likelihoods</span>

    <span class="c1"># Derive marginal distributions of both centers and widths</span>
    <span class="n">intercept_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> \
                                  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">width_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">dgr_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Derive confidence intervals of parameters</span>
    <span class="n">width_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">width_grid</span><span class="p">,</span>
                                   <span class="n">width_likelihood</span><span class="p">,</span>
                                   <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">dgr_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">,</span>
                                 <span class="n">dgr_likelihood</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">intercept_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">,</span>
                                 <span class="n">intercept_likelihood</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>

    <span class="c1"># Get values of best-fit model parameters</span>
    <span class="n">max_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">likelihoods</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">))</span>

    <span class="n">width_max</span> <span class="o">=</span> <span class="n">width_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">dgr_max</span> <span class="o">=</span> <span class="n">dgr_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">intercept_max</span> <span class="o">=</span> <span class="n">intercept_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">width_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dgr_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">dgr_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">width_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">intercept_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">intercept_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">print_vel_range</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">Width confint = &#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} km/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">width_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">width_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">DGR confint = &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} 10^-20 cm^2 mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dgr_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">dgr_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dgr_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">Intercept confint = &#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">intercept_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">intercept_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="c1"># Write PDF</span>
    <span class="k">if</span> <span class="n">vel_center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vel_center</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">upper_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">+</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">lower_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">-</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">upper_lim_error</span> <span class="o">=</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">lower_lim_error</span> <span class="o">=</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">vel_range_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">,</span> <span class="n">lower_lim_error</span><span class="p">,</span>
                         <span class="n">upper_lim_error</span><span class="p">)</span>
    <span class="n">vel_range_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">width_max</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">vel_center</span> <span class="o">+</span> <span class="n">width_max</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
               <span class="s1">&#39;vel_range_confint&#39;</span><span class="p">:</span> <span class="n">vel_range_confint</span><span class="p">,</span>
               <span class="s1">&#39;width_confint&#39;</span><span class="p">:</span> <span class="n">width_confint</span><span class="p">,</span>
               <span class="s1">&#39;dgr_confint&#39;</span><span class="p">:</span> <span class="n">dgr_confint</span><span class="p">,</span>
               <span class="s1">&#39;intercept_confint&#39;</span><span class="p">:</span> <span class="n">intercept_confint</span><span class="p">,</span>
               <span class="s1">&#39;likelihoods&#39;</span><span class="p">:</span> <span class="n">likelihoods</span><span class="p">,</span>
               <span class="s1">&#39;width_likelihood&#39;</span><span class="p">:</span> <span class="n">width_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;dgr_likelihood&#39;</span><span class="p">:</span> <span class="n">dgr_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;intercept_likelihood&#39;</span><span class="p">:</span> <span class="n">intercept_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;width_max&#39;</span><span class="p">:</span> <span class="n">width_max</span><span class="p">,</span>
               <span class="s1">&#39;dgr_max&#39;</span><span class="p">:</span> <span class="n">dgr_max</span><span class="p">,</span>
               <span class="s1">&#39;intercept_max&#39;</span><span class="p">:</span> <span class="n">intercept_max</span><span class="p">,</span>
               <span class="s1">&#39;vel_range_max&#39;</span><span class="p">:</span> <span class="n">vel_range_max</span>
               <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_likelihoods</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vel_range_confint</span><span class="p">,</span> <span class="n">dgr_confint</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="kn">from</span> <span class="nn">multiprocessing.queues</span> <span class="kn">import</span> <span class="n">Queue</span>

<div class="viewcode-block" id="QueueGet"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.QueueGet">[docs]</a><span class="k">class</span> <span class="nc">QueueGet</span><span class="p">(</span><span class="n">Queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Queue which will retry if interrupted with EINTR.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="QueueGet.get"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.QueueGet.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">retry_on_eintr</span><span class="p">(</span><span class="n">Queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="retry_on_eintr"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.retry_on_eintr">[docs]</a><span class="k">def</span> <span class="nf">retry_on_eintr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">multiprocessing.queues</span> <span class="kn">import</span> <span class="n">Queue</span>
    <span class="kn">import</span> <span class="nn">errno</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>

<span class="k">def</span> <span class="nf">_my_queue_get</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">errno</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINTR</span><span class="p">:</span>
                <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_calc_likelihoods</span><span class="p">(</span>
        <span class="n">hi_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">hi_vel_axis</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">nhi_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">av_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">av_image_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">bin_weights</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">use_bin_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">vel_center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">width_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">dgr_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">intercept_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">plot_results</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">results_filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">return_likelihoods</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">likelihood_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">conf</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span>
        <span class="n">threshold_delta_dgr</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vel_range : tuple</span>
<span class="sd">        Lower and upper bound of HI velocity range in km/s which provides the</span>
<span class="sd">        best likelihoodelated N(HI) distribution with Av.</span>
<span class="sd">    likelihoods : array-like, optional</span>
<span class="sd">        Array of Pearson likelihoodelation coefficients likelihoodesponding to each</span>
<span class="sd">        permutation through the velocity centers and velocity widths.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">calc_symmetric_error</span><span class="p">,</span> <span class="n">calc_logL</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>

    <span class="c1"># Check if likelihood grid should be derived</span>
    <span class="k">if</span> <span class="n">likelihood_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">):</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># If no filename provided, do not read file and do not write file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_mle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">perform_mle</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">perform_mle</span><span class="p">:</span>
        <span class="c1"># calculate the likelihoodelation coefficient for each velocity</span>
        <span class="c1"># range</span>
        <span class="k">if</span> <span class="n">width_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">width_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dgr_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dgr_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intercept_grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">intercept_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">width_grid</span><span class="p">),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">),</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">)))</span>

        <span class="c1"># Progress bar parameters</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">likelihoods</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image_error</span><span class="p">,</span>
                       <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/resid.png&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">nhi_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Remove nans</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">av_image</span> <span class="o">!=</span> <span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">av_image_error</span> <span class="o">!=</span> <span class="n">av_image_error</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">av_image_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                    <span class="p">(</span><span class="n">nhi_image</span> <span class="o">!=</span> <span class="n">nhi_image</span><span class="p">))</span>

            <span class="n">av_image</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">av_image_error</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">nhi_image</span> <span class="o">=</span> <span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use_bin_weights</span> <span class="ow">and</span> <span class="n">bin_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">bin_weights</span> <span class="o">=</span> <span class="n">bin_weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

            <span class="n">print_vel_range</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c1"># Cycle through DGR to estimate error</span>
            <span class="n">width_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">vel_width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">width_grid</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">):</span>
                        <span class="c1"># Create model of Av with N(HI) and DGR</span>
                        <span class="n">av_image_model</span> <span class="o">=</span> <span class="n">nhi_image</span> <span class="o">*</span> <span class="n">dgr</span> <span class="o">+</span> <span class="n">intercept</span>

                        <span class="n">logL</span> <span class="o">=</span> <span class="n">calc_logL</span><span class="p">(</span><span class="n">av_image_model</span><span class="p">,</span>
                                         <span class="n">av_image</span><span class="p">,</span>
                                         <span class="n">data_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                         <span class="p">)</span>

                        <span class="c1">#print logL</span>
                        <span class="n">likelihoods</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">logL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_vel_range</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c1"># Remove nans</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_bin_weights</span><span class="p">:</span>
                <span class="n">hi_cube</span><span class="p">[</span><span class="n">hi_cube</span> <span class="o">!=</span> <span class="n">hi_cube</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">av_image</span> <span class="o">!=</span> <span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
                        <span class="p">(</span><span class="n">av_image_error</span> <span class="o">!=</span> <span class="n">av_image_error</span><span class="p">)</span> <span class="o">|</span> \
                        <span class="p">(</span><span class="n">av_image_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

                <span class="n">av_image</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">av_image_error</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">hi_cube</span> <span class="o">=</span> <span class="n">hi_cube</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># Weight images</span>
            <span class="c1">#bin_weights = None</span>
            <span class="k">if</span> <span class="n">use_bin_weights</span> <span class="ow">and</span> <span class="n">bin_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">av_image</span><span class="p">,</span> <span class="n">av_image_error</span><span class="p">,</span> <span class="n">hi_cube</span> <span class="o">=</span> \
                    <span class="n">_prep_weighted_data</span><span class="p">(</span><span class="n">av_image</span><span class="o">=</span><span class="n">av_image</span><span class="p">,</span>
                                        <span class="n">av_image_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                        <span class="n">hi_cube</span><span class="o">=</span><span class="n">hi_cube</span><span class="p">,</span>
                                        <span class="n">weights</span><span class="o">=</span><span class="n">bin_weights</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

                <span class="n">j</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span>
                <span class="n">vel_width</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;vel_width&#39;</span><span class="p">]</span>
                <span class="n">likelihoods_temp</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">)))</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>


                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">vel_width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                                          <span class="n">vel_center</span> <span class="o">+</span> <span class="n">vel_width</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>

                    <span class="n">nhi_image</span> <span class="o">=</span> <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="n">hi_cube</span><span class="p">,</span>
                                              <span class="n">velocity_axis</span><span class="o">=</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                                              <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                                              <span class="n">return_nhi_error</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                    <span class="c1"># Cycle through DGR to estimate error</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">):</span>
                            <span class="c1"># Create model of Av with N(HI) and DGR</span>
                            <span class="n">av_image_model</span> <span class="o">=</span> <span class="n">nhi_image</span> <span class="o">*</span> <span class="n">dgr</span> <span class="o">+</span> <span class="n">intercept</span>

                            <span class="n">logL</span> <span class="o">=</span> <span class="n">calc_logL</span><span class="p">(</span><span class="n">av_image_model</span><span class="p">,</span>
                                             <span class="n">av_image</span><span class="p">,</span>
                                             <span class="n">data_error</span><span class="o">=</span><span class="n">av_image_error</span><span class="p">,</span>
                                             <span class="p">)</span>

                            <span class="n">likelihoods_temp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">logL</span>

                            <span class="c1">#print vel_width, dgr, intercept, logL</span>
                            <span class="c1">#print vel_width, dgr, intercept, logL</span>

                    <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="n">likelihoods_temp</span><span class="p">])</span>

                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">KeyboardInterruptError</span><span class="p">()</span>

            <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># use all but one cpu</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">:</span> <span class="n">likelihoods</span><span class="p">,</span>
                    <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span>
                    <span class="p">}</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">vel_width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">width_grid</span><span class="p">):</span>
                <span class="c1"># Construct N(HI) image outside of DGR loop, then apply</span>
                <span class="c1"># dgr_grid in loop</span>

                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;vel_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vel_width</span>


                <span class="k">try</span><span class="p">:</span>
                    <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="p">,)))</span>

                    <span class="n">processes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>


                <span class="n">result</span> <span class="o">=</span> <span class="n">_my_queue_get</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dgr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">intercept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">):</span>
                            <span class="k">print</span><span class="p">(</span><span class="n">width_grid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dgr_grid</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                  <span class="n">intercept_grid</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>

                <span class="n">likelihoods</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Load file of likelihoods</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">perform_mle</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Reading likelihood grid file:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">)</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">likelihood_filename</span><span class="p">)</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">width_grid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
           <span class="nb">len</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">)</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Specified parameter grid not the same as in&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;loaded data likelihoods.&#39;</span><span class="p">)</span>

        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">likelihoods</span> <span class="o">!=</span> <span class="n">likelihoods</span><span class="p">))</span>

    <span class="c1"># Normalize the log likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Convert to likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">likelihoods</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Normalize the likelihoods</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">likelihoods</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1">#print width_grid</span>
    <span class="c1">#print dgr_grid</span>
    <span class="c1">#print intercept_grid</span>
    <span class="c1">#print likelihoods</span>

    <span class="c1"># Derive marginal distributions of both centers and widths</span>
    <span class="n">intercept_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> \
                                  <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">width_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="n">dgr_likelihood</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Derive confidence intervals of parameters</span>
    <span class="n">width_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">width_grid</span><span class="p">,</span>
                                   <span class="n">width_likelihood</span><span class="p">,</span>
                                   <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">dgr_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">dgr_grid</span><span class="p">,</span>
                                 <span class="n">dgr_likelihood</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>
    <span class="n">intercept_confint</span> <span class="o">=</span> <span class="n">calc_symmetric_error</span><span class="p">(</span><span class="n">intercept_grid</span><span class="p">,</span>
                                 <span class="n">intercept_likelihood</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>

    <span class="c1"># Get values of best-fit model parameters</span>
    <span class="n">max_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">likelihoods</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">))</span>

    <span class="n">width_max</span> <span class="o">=</span> <span class="n">width_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">dgr_max</span> <span class="o">=</span> <span class="n">dgr_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">intercept_max</span> <span class="o">=</span> <span class="n">intercept_grid</span><span class="p">[</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">width_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dgr_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">dgr_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                   <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">width_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">width_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">intercept_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">intercept_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">print_vel_range</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">Width confint = &#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} km/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">width_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">width_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">DGR confint = &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} 10^-20 cm^2 mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dgr_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">dgr_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dgr_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t\t\t</span><span class="s1">Intercept confint = &#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;{0:.2f} +{1:.2f}/-{2:.2f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">intercept_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">intercept_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

    <span class="c1"># Write PDF</span>
    <span class="k">if</span> <span class="n">vel_center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vel_center</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">upper_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">+</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">lower_lim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vel_center</span><span class="p">)</span> <span class="o">-</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">upper_lim_error</span> <span class="o">=</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">lower_lim_error</span> <span class="o">=</span> <span class="n">width_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">vel_range_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">,</span> <span class="n">lower_lim_error</span><span class="p">,</span>
                         <span class="n">upper_lim_error</span><span class="p">)</span>
    <span class="n">vel_range_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">width_max</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">vel_center</span> <span class="o">+</span> <span class="n">width_max</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
               <span class="s1">&#39;vel_range_confint&#39;</span><span class="p">:</span> <span class="n">vel_range_confint</span><span class="p">,</span>
               <span class="s1">&#39;width_confint&#39;</span><span class="p">:</span> <span class="n">width_confint</span><span class="p">,</span>
               <span class="s1">&#39;dgr_confint&#39;</span><span class="p">:</span> <span class="n">dgr_confint</span><span class="p">,</span>
               <span class="s1">&#39;intercept_confint&#39;</span><span class="p">:</span> <span class="n">intercept_confint</span><span class="p">,</span>
               <span class="s1">&#39;likelihoods&#39;</span><span class="p">:</span> <span class="n">likelihoods</span><span class="p">,</span>
               <span class="s1">&#39;width_likelihood&#39;</span><span class="p">:</span> <span class="n">width_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;dgr_likelihood&#39;</span><span class="p">:</span> <span class="n">dgr_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;intercept_likelihood&#39;</span><span class="p">:</span> <span class="n">intercept_likelihood</span><span class="p">,</span>
               <span class="s1">&#39;width_max&#39;</span><span class="p">:</span> <span class="n">width_max</span><span class="p">,</span>
               <span class="s1">&#39;dgr_max&#39;</span><span class="p">:</span> <span class="n">dgr_max</span><span class="p">,</span>
               <span class="s1">&#39;intercept_max&#39;</span><span class="p">:</span> <span class="n">intercept_max</span><span class="p">,</span>
               <span class="s1">&#39;vel_range_max&#39;</span><span class="p">:</span> <span class="n">vel_range_max</span>
               <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_likelihoods</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vel_range_confint</span><span class="p">,</span> <span class="n">dgr_confint</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">_make_av_model</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">,</span> <span class="n">dgr</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">av_background</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="n">av_model</span> <span class="o">=</span> <span class="n">dgr</span> <span class="o">*</span> <span class="p">(</span><span class="n">nhi_image</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span>

    <span class="k">return</span> <span class="n">av_model</span>

<span class="k">def</span> <span class="nf">_fit_params</span><span class="p">(</span><span class="n">nhi_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">av_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">av_image_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">include_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">av_image_error</span><span class="p">))</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_intercept</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nhi_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">DGR = {0:.3f} [10^-20 cm^2 mag]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Intercept = {0:.3f} [mag]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;dgr_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;intercept_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#results[&#39;intercept_max&#39;] = 0</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">_prep_weighted_data</span><span class="p">(</span><span class="n">av_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">av_image_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">hi_cube</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">weights</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">hi_cube</span><span class="p">[</span><span class="n">hi_cube</span> <span class="o">!=</span> <span class="n">hi_cube</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">av_image</span> <span class="o">!=</span> <span class="n">av_image</span><span class="p">)</span> <span class="o">|</span> \
                <span class="p">(</span><span class="n">av_image_error</span> <span class="o">!=</span> <span class="n">av_image_error</span><span class="p">)</span> <span class="o">|</span> \
                <span class="p">(</span><span class="n">av_image_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                <span class="p">(</span><span class="n">weights</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> \
                <span class="p">(</span><span class="n">weights</span> <span class="o">!=</span> <span class="n">weights</span><span class="p">))</span>

        <span class="n">av_image</span> <span class="o">=</span> <span class="n">av_image</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">av_image_error</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">hi_cube</span> <span class="o">=</span> <span class="n">hi_cube</span><span class="p">[:,</span> <span class="o">~</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># omit 0 weights</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">av_image</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">av_image_error</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">hi_cube</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">av_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">av_image_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
        <span class="n">hi_cube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">hi_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)):</span>
            <span class="n">av_image</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">av_image_error</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hi_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">hi_cube</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span><span class="n">count</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>


        <span class="k">return</span> <span class="p">(</span><span class="n">av_image</span><span class="p">,</span> <span class="n">av_image_error</span><span class="p">,</span> <span class="n">hi_cube</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_residual_mask</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">residual_width_scale</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">plot_args</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">use_GMM</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#import numpy as np</span>
    <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">gauss</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">minimize</span>
    <span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GMM</span><span class="p">,</span> <span class="n">DPGMM</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

    <span class="c1"># Fit the rising portion of the residuals, find KD peak</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)],</span>
                           <span class="n">bw_method</span><span class="o">=</span><span class="s1">&#39;silverman&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">peak_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span><span class="c1"># + 0.05</span>
    <span class="n">peak_threshold</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">counts</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">counts</span><span class="p">))][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Peak threshold = {0:.2f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_threshold</span><span class="p">))</span>

    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">peak_threshold</span>
    <span class="n">residuals_crop1</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[(</span><span class="n">residuals</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)</span> <span class="o">&amp;</span> \
                               <span class="c1">#(residuals &gt; -1.5) &amp; \</span>
                                <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)]</span>

    <span class="n">residuals_crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">residuals_crop1</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">residuals_crop1</span> <span class="o">-</span>
        <span class="n">cutoff</span><span class="p">)</span> <span class="o">+</span> <span class="n">cutoff</span><span class="p">))</span>

    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#plt.plot(x, gaussian_kde(residuals_crop)(x))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals_crop</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/hist.png&#39;</span><span class="p">)</span>

    <span class="c1">#residuals_crop = residuals[(residuals &lt; 0) &amp; \</span>
    <span class="c1">#                           #(residuals &gt; -1.5) &amp; \</span>
    <span class="c1">#                            ~np.isnan(residuals)]</span>

    <span class="c1">#if not use_GMM:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_GMM</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1">#print(&#39;histing&#39;)</span>
        <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Parameters</span>

        <span class="c1"># Set parameter limits and initial guesses</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                   <span class="nb">min</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                   <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                   <span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
                   <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="nb">max</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
                   <span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="nb">min</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
                   <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">vary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="p">)</span>

        <span class="c1">#bin_edges = residuals_crop</span>
        <span class="c1">#counts = np.ones(residuals_crop.size - 1)</span>

        <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>

            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">counts</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">norm</span>

        <span class="c1">#print(&#39;fitting&#39;)</span>
        <span class="c1"># Perform the fit!</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span>
                          <span class="n">params</span><span class="p">,</span>
                          <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">counts</span><span class="p">),</span>
                          <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lbfgsb&#39;</span>
                          <span class="p">)</span>

        <span class="c1">#print(&#39;done fitting&#39;)</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_GMM</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GMM</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">residuals_crop</span><span class="p">)</span>
        <span class="n">fit_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">covars_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">means_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Fitted mean = {0:.2f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">means_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span>
                            <span class="mi">1000</span><span class="p">)</span>
        <span class="c1">#y_fit = np.exp(g.score_samples(x_fit)[0])</span>
        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="c1">#fit_params[0] = y_fit[y_fit == 2.35 * max(y_fit)]/2.0</span>

    <span class="c1"># Include only residuals within 3 sigma</span>
    <span class="c1">#fit_parms[2] = 0</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">residual_thres</span> <span class="o">=</span> <span class="n">residual_width_scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">intercept</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">residuals</span> <span class="o">&gt;</span> <span class="n">residual_thres</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Residual threshold = {0:.2f} [mag]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">residual_thres</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">Residual intercept = {0:.2f} [mag]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;residual_hist_filename_base&#39;</span> <span class="ow">in</span> <span class="n">plot_args</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
                            <span class="mi">10</span><span class="p">,</span>
                            <span class="mi">1000</span><span class="p">)</span>

        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="n">y_fit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>

        <span class="c1">#y_fit = np.exp(g.eval(x_fit)[0])</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;residual_hist_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>

        <span class="k">if</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0_0&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;residual_hist_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="c1">#print(&#39;\nSaving residual mask PDF figure to\n&#39; + results_filename)</span>
        <span class="n">plot_mask_residuals</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span>
                            <span class="n">x_fit</span><span class="o">=</span><span class="n">x_fit</span><span class="p">,</span>
                            <span class="n">y_fit</span><span class="o">=</span><span class="n">y_fit</span><span class="p">,</span>
                            <span class="n">residual_thres</span><span class="o">=</span><span class="n">residual_thres</span><span class="p">,</span>
                            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                            <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;residual_map_filename_base&#39;</span> <span class="ow">in</span> <span class="n">plot_args</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;residual_map_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>

        <span class="k">if</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;iter_ext&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0_0&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;residual_map_filename_base&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>

        <span class="c1">#print(&#39;\nSaving residual mask PDF figure to\n&#39; + results_filename)</span>
        <span class="n">plot_residual_map</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span>
                          <span class="n">header</span><span class="o">=</span><span class="n">plot_args</span><span class="p">[</span><span class="s1">&#39;av_header&#39;</span><span class="p">],</span>
                          <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                          <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                          <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mask</span><span class="p">,</span> <span class="n">residual_thres</span><span class="p">,</span> <span class="n">fit_params</span>

<span class="k">def</span> <span class="nf">_check_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">os</span>

    <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Image {:s} exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Deleting image {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">exists</span>

<div class="viewcode-block" id="save"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">binary_likelihood_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">write_fits</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="c1"># Writ the likelihoods as a numpy binary array, much more efficient</span>
    <span class="k">if</span> <span class="n">binary_likelihood_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">binary_likelihood_filename</span><span class="p">,</span> <span class="n">likelihoods</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">write_fits</span><span class="p">:</span>
        <span class="n">av_data</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span>
        <span class="n">av_error_data</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_data</span>
        <span class="n">hi_data</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">hi_data</span>
        <span class="n">hi_error_data</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">hi_error_data</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">hi_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">hi_error_data</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">write_fits</span><span class="p">:</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span> <span class="o">=</span> <span class="n">av_data</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="n">av_error_data</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">hi_data</span> <span class="o">=</span> <span class="n">hi_data</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">hi_error_data</span> <span class="o">=</span> <span class="n">hi_error_data</span>

    <span class="c1"># Add the likelihoods back to the cloud</span>
    <span class="k">if</span> <span class="n">binary_likelihood_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">likelihoods</span></div>

<div class="viewcode-block" id="load"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">binary_likelihood_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">load_fits</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">input</span><span class="p">:</span>
        <span class="n">cloud</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">load_fits</span><span class="p">:</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_error_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cloud</span><span class="o">.</span><span class="n">av_error_data</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_error</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">cloud</span><span class="o">.</span><span class="n">hi_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binary_likelihood_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
         <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">binary_likelihood_filename</span><span class="p">)</span>

    <span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">likelihoods</span>

    <span class="k">return</span> <span class="n">cloud</span></div>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Plotting</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="k">def</span> <span class="nf">_build_likelihoods_hist_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;widths&#39;</span><span class="p">,</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">),</span> <span class="n">contour_confs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,),</span>
        <span class="n">show_pdfs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Plots a heat map of likelihoodelation values as a function of velocity</span>
<span class="sd">    width and velocity center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud : cloudpy.Cloud</span>
<span class="sd">        If provided, properties taken from cloud.props.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>

    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>

    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Define parameters from cloud</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Velocity Width [km/s]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Width PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Velocity Width [km/s]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Width PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dgrs&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;DGR PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dgrs&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;DGR PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;intercepts&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Intercept PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;intercepts&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Intercept PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>

    <span class="c1"># Create axes</span>
    <span class="n">sum_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x_sum_axes</span><span class="p">,</span> <span class="n">y_sum_axes</span><span class="p">))</span>
    <span class="n">sum_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">sum_axes</span><span class="p">)))</span>

    <span class="c1"># Mask NaNs</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">])</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">))</span>

    <span class="c1"># Create likelihood image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">sum_axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Derive marginal distributions of both centers and widths</span>
    <span class="n">x_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">x_sum_axes</span><span class="p">)</span>
    <span class="n">x_pdf</span> <span class="o">=</span> <span class="n">x_sum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_sum</span><span class="p">)</span>
    <span class="n">y_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">y_sum_axes</span><span class="p">)</span>
    <span class="n">y_pdf</span> <span class="o">=</span> <span class="n">y_sum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_sum</span><span class="p">)</span>

    <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x_extent</span><span class="p">,</span> <span class="n">y_extent</span><span class="p">)))</span>

    <span class="c1">#plt.rc(&#39;text&#39;, usetex=False)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="c1">#cmap=plt.cm.gist_stern,</span>
            <span class="c1">#cmap=plt.cm.gray,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm(),</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Limit the number of tick marks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>


    <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">show_pdfs</span><span class="p">:</span>
        <span class="c1"># ---------</span>
        <span class="c1"># Plot PDFs</span>
        <span class="c1"># ---------</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_pdf_x</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># make some labels invisible</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span>
                      <span class="n">x_pdf</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="p">)</span>


        <span class="c1">#axHistx.axis[&quot;bottom&quot;].major_ticklabels.set_visible(False)</span>

        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Tick marks on the pdf?</span>
        <span class="n">pdf_ticks</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">pdf_ticks</span><span class="p">:</span>
            <span class="n">wmax</span> <span class="o">=</span> <span class="n">x_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">wmax</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">wmax</span><span class="p">]</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="p">]</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_pdf_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_confint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">show_pdfs</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_pdf_y</span>  <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">sharey</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pdf</span><span class="p">,</span>
                      <span class="n">y_grid</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="p">)</span>

        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">y_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cmax</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">cmax</span><span class="p">]</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="p">]</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_pdf_label</span><span class="p">)</span>

        <span class="c1"># ----------------------</span>
        <span class="c1"># Show confidence limits</span>
        <span class="c1"># ----------------------</span>
        <span class="k">if</span> <span class="n">y_confint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="c1">#cb.set_clim(vmin=0.)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="c1">#cb.set_label_text(r&#39;log L&#39;)</span>

    <span class="c1"># -------------</span>
    <span class="c1"># Plot contours</span>
    <span class="c1"># -------------</span>
    <span class="k">if</span> <span class="n">contour_confs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

        <span class="n">fractions</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">contour_confs</span><span class="p">))</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">fractions</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span>
                <span class="p">)</span>

        <span class="c1"># Define a class that forces representation of float to look a certain</span>
        <span class="c1"># way This remove trailing zero so &#39;1.0&#39; becomes &#39;1&#39;</span>
        <span class="k">class</span> <span class="nc">nf</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
             <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                 <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">(),)</span>
                 <span class="k">if</span> <span class="nb">str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0&#39;</span><span class="p">:</span>
                     <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">()</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">()</span>

        <span class="c1"># Recast levels to new class</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">nf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">contour_confs</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span><span class="p">]</span>

        <span class="c1">#fmt = {}</span>
        <span class="c1">#for level, fraction in zip(cs.levels, fractions):</span>
        <span class="c1">#    fmt[level] = fraction</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vert_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_paths</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_max</span><span class="p">:</span>
                        <span class="n">vert_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_min</span><span class="p">:</span>
                        <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="n">x_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert_max</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span>

                <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">vert_min</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">,</span>\
                               <span class="n">vert_max</span> <span class="o">+</span> <span class="n">x_offset</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vert_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_paths</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_max</span><span class="p">:</span>
                        <span class="n">vert_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_min</span><span class="p">:</span>
                        <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

                <span class="n">y_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vert_max</span><span class="p">)</span><span class="o">*</span><span class="mf">0.25</span>

                <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">vert_min</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span>\
                               <span class="n">vert_max</span> <span class="o">+</span> <span class="n">y_offset</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># Set limits</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1">#if npix is not None or av_threshold is not None:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">npix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;N$_{\rm pix}$ = &#39;</span> <span class="o">+</span> \
                     <span class="s1">&#39;{0:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">av_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">av_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;$A_V$ threshold = {0:.1f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">av_threshold</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;DGR = {0:.2f} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">r&#39;$\times$ 10$^{-20}$ (cm$^2$ mag$^1$)&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;Velocity width = {0:.2f} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">r&#39;km/s&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">font_scale</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span>
                          <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">__plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">width_limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">dgr_limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">intercept_limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">returnimage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">contour_confs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,)):</span>

    <span class="sd">&#39;&#39;&#39; Plots a heat map of likelihoodelation values as a function of velocity</span>
<span class="sd">    width and velocity center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud : cloudpy.Cloud</span>
<span class="sd">        If provided, properties taken from cloud.props.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>

    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_build_likelihoods_hist_axis</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">cloud</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span>
                                           <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
                                           <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dgrs&#39;</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">),</span>
                                           <span class="n">contour_confs</span><span class="o">=</span><span class="n">contour_confs</span><span class="p">,</span>
                                           <span class="c1">#xlim=dgr_limits,</span>
                                           <span class="c1">#ylim=width_limits,</span>
                                           <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">],</span>
                                           <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span>
                                           <span class="n">pdf</span><span class="o">=</span><span class="s1">&#39;dgr&#39;</span><span class="p">,</span>
                                           <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_build_likelihoods_hist_axis</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">cloud</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span>
                                            <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
                                            <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;intercepts&#39;</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">),</span>
                                            <span class="n">contour_confs</span><span class="o">=</span><span class="n">contour_confs</span><span class="p">,</span>
                                            <span class="c1">#xlim=intercept_limits,</span>
                                            <span class="c1">#ylim=width_limits,</span>
                                            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span>
                                            <span class="n">show_pdfs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span>
                                            <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_build_likelihoods_hist_axis</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                            <span class="n">cloud</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span>
                                            <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">,</span>
                                            <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;intercepts&#39;</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">),</span>
                                            <span class="n">contour_confs</span><span class="o">=</span><span class="n">contour_confs</span><span class="p">,</span>
                                            <span class="c1">#xlim=intercept_limits,</span>
                                            <span class="c1">#ylim=width_limits,</span>
                                            <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                            <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span>
                                            <span class="n">show_pdfs</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                                            <span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1">#axes[1].set_yticklabels(visible=False)</span>
    <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Get same y axis limits</span>
    <span class="c1">#axes[1].set_ylim(axes[0].get_ylim())</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1">#plt.draw()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnimage</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">likelihoods</span>

<div class="viewcode-block" id="plot_likelihoods_hist"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_likelihoods_hist">[docs]</a><span class="k">def</span> <span class="nf">plot_likelihoods_hist</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">returnimage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plot_axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;widths&#39;</span><span class="p">,</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">contour_confs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,),</span> <span class="n">logscale</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Plots a heat map of likelihoodelation values as a function of velocity</span>
<span class="sd">    width and velocity center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud : cloudpy.Cloud</span>
<span class="sd">        If provided, properties taken from cloud.props.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="c1"># Define parameters from cloud</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Velocity Width [km/s]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Width PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;width_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_width_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Velocity Width [km/s]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Width PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dgrs&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;DGR PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dgrs&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dgr_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;dust2gas_ratio_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;DGR PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;intercepts&#39;</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_grid&#39;</span><span class="p">]</span>
        <span class="n">x_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">x_extent</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>
        <span class="n">x_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Intercept PDF&#39;</span>
        <span class="c1">#if xlim is None:</span>
        <span class="c1">#    xlim = (x_grid[0], x_grid[-1])</span>
    <span class="k">if</span> <span class="n">plot_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;intercepts&#39;</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_grid&#39;</span><span class="p">]</span>
        <span class="n">y_confint</span> <span class="o">=</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">props</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="p">)</span>
        <span class="n">y_extent</span> <span class="o">=</span> <span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>
        <span class="n">y_sum_axes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_pdf_label</span> <span class="o">=</span> <span class="s1">&#39;Intercept PDF&#39;</span>
        <span class="c1">#if ylim is None:</span>
        <span class="c1">#    ylim = (y_grid[0], y_grid[-1])</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y_limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_limits</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">y_limits</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="c1"># Create axes</span>
    <span class="n">sum_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x_sum_axes</span><span class="p">,</span> <span class="n">y_sum_axes</span><span class="p">))</span>
    <span class="n">sum_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">sum_axes</span><span class="p">)))</span>

    <span class="c1"># Mask NaNs</span>
    <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;likelihoods&#39;</span><span class="p">])</span>
    <span class="c1">#image = np.ma.array(likelihoods, mask=np.isnan(likelihoods))</span>

    <span class="c1"># Create likelihood image</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">sum_axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">)</span>

    <span class="c1"># Derive marginal distributions of both centers and widths</span>
    <span class="n">x_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">x_sum_axes</span><span class="p">)</span>
    <span class="n">x_pdf</span> <span class="o">=</span> <span class="n">x_sum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_sum</span><span class="p">)</span>
    <span class="n">y_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">y_sum_axes</span><span class="p">)</span>
    <span class="n">y_pdf</span> <span class="o">=</span> <span class="n">y_sum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_sum</span><span class="p">)</span>

    <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x_extent</span><span class="p">,</span> <span class="n">y_extent</span><span class="p">)))</span>

    <span class="c1">#plt.rc(&#39;text&#39;, usetex=False)</span>

    <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="c1">#cmap=plt.cm.gist_stern,</span>
            <span class="c1">#cmap=plt.cm.gray,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
            <span class="c1">#vmin=np.max(image)/3.0,</span>
            <span class="c1">#vmax=,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">show_pdfs</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">show_pdfs</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_pdf_x</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_pdf_y</span>  <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">sharey</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1"># make some labels invisible</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> \
                 <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span>
                 <span class="n">visible</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span>
                      <span class="n">x_pdf</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="p">)</span>

        <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_pdf</span><span class="p">,</span>
                      <span class="n">y_grid</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-mid&#39;</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="p">)</span>

        <span class="c1">#axHistx.axis[&quot;bottom&quot;].major_ticklabels.set_visible(False)</span>

        <span class="c1"># Tick marks on the pdf?</span>
        <span class="n">pdf_ticks</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf_ticks</span><span class="p">:</span>
            <span class="n">wmax</span> <span class="o">=</span> <span class="n">x_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">wmax</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">wmax</span><span class="p">]</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="p">]</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_pdf_label</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pdf_ticks</span><span class="p">:</span>
            <span class="n">cmax</span> <span class="o">=</span> <span class="n">y_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cmax</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">cmax</span><span class="p">]</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                           <span class="s1">&#39;{0:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticks</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                            <span class="p">]</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_pdf_label</span><span class="p">)</span>

        <span class="c1"># Show confidence limits</span>
        <span class="k">if</span> <span class="n">y_confint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax_pdf_y</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                             <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_confint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_confint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_confint</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax_pdf_x</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#cb.set_clim(vmin=0.)</span>
    <span class="c1"># Write label to colorbar</span>
    <span class="c1">#cb.set_label_text(r&#39;log L&#39;)</span>

    <span class="c1"># Plot contours</span>
    <span class="k">if</span> <span class="n">contour_confs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

        <span class="n">fractions</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">contour_confs</span><span class="p">))</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="n">fractions</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span>
                <span class="p">)</span>

        <span class="c1"># Define a class that forces representation of float to look a certain</span>
        <span class="c1"># way This remove trailing zero so &#39;1.0&#39; becomes &#39;1&#39;</span>
        <span class="k">class</span> <span class="nc">nf</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span>
             <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                 <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">(),)</span>
                 <span class="k">if</span> <span class="nb">str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0&#39;</span><span class="p">:</span>
                     <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">()</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__float__</span><span class="p">()</span>

        <span class="c1"># Recast levels to new class</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">nf</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">contour_confs</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span><span class="p">]</span>

        <span class="c1">#fmt = {}</span>
        <span class="c1">#for level, fraction in zip(cs.levels, fractions):</span>
        <span class="c1">#    fmt[level] = fraction</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># --------------</span>
        <span class="c1"># Set boundaries</span>
        <span class="c1"># --------------</span>
        <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># X limits</span>
            <span class="c1"># --------</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vert_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">get_paths</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_max</span><span class="p">:</span>
                            <span class="n">vert_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">vert_min</span><span class="p">:</span>
                            <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="n">x_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vert_max</span><span class="p">))</span><span class="o">*</span><span class="mf">0.25</span>

                <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">vert_min</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">,</span>\
                               <span class="n">vert_max</span> <span class="o">+</span> <span class="n">x_offset</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Y limits</span>
            <span class="c1"># --------</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vert_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
                <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">get_paths</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">vert_max</span><span class="p">:</span>
                            <span class="n">vert_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">vert_min</span><span class="p">:</span>
                            <span class="n">vert_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>


                <span class="n">y_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vert_max</span><span class="p">))</span><span class="o">*</span><span class="mf">0.25</span>

                <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">vert_min</span> <span class="o">-</span> <span class="n">y_offset</span><span class="p">,</span>\
                               <span class="n">vert_max</span> <span class="o">+</span> <span class="n">y_offset</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1">#if npix is not None or av_threshold is not None:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">npix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;N$_{\rm pix}$ = &#39;</span> <span class="o">+</span> \
                     <span class="s1">&#39;{0:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">av_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">av_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;$A_V$ threshold = {0:.1f} mag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">av_threshold</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;DGR = {0:.2f} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">r&#39;$\times$ 10$^{-20}$ (cm$^2$ mag$^1$)&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">r&#39;Velocity width = {0:.2f} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x_confint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">r&#39;km/s&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">font_scale</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span>
                          <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnimage</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">likelihoods</span></div>

<span class="k">def</span> <span class="nf">plot_av_bin_map</span><span class="p">(</span><span class="n">av_map</span><span class="p">,</span> <span class="n">av_bin_map</span><span class="p">,</span> <span class="n">av_header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">av_header_bin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># colormaps</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_ncar</span>
    <span class="c1">#color_cycle = [colormap(i) for i in np.linspace(0, 0.9, len(flux_list))]</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># Original map</span>
    <span class="c1"># ------------</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">av_header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span> <span class="c1"># colormap</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_map</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="c1"># Binned map</span>
    <span class="c1"># ----------</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">av_header_bin</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span> <span class="c1"># colormap</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_bin_map</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_dgr_intercept_progression</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span> <span class="k">as</span> <span class="n">integrate</span>

    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">)</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nrows</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>

        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">iter_dict</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;masking_var&#39;</span><span class="p">]</span>

        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iter_dict</span><span class="p">)</span>
        <span class="n">dgrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
        <span class="n">intercepts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iter_dict</span><span class="p">):</span>
            <span class="n">dgrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;dgr&#39;</span><span class="p">]</span>
            <span class="n">intercepts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>
            <span class="n">npix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">dgrs</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                 <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                 <span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Number of Unmasked Pixels&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">vel_range</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;vel_range&#39;</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vel_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">r&#39;$\Delta_V$ = {0:.0f} km/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<div class="viewcode-block" id="plot_mask_residuals"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_mask_residuals">[docs]</a><span class="k">def</span> <span class="nf">plot_mask_residuals</span><span class="p">(</span><span class="n">residuals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x_fit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y_fit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">fit_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">residual_thres</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">anno_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">factor</span><span class="o">=</span><span class="s1">&#39;silverman&#39;</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span> <span class="k">as</span> <span class="n">integrate</span>
    <span class="kn">from</span> <span class="nn">mystats</span> <span class="kn">import</span> <span class="n">gauss</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">residuals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">residuals_nonans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)])</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">residuals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">residuals_nonans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">residuals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)])</span>
            <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">residuals_nonans</span><span class="p">,</span>
                             <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">residuals_nonans</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">),</span>
                             <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="n">bin_edges_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">counts_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">bin_edges_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bin_edges_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">counts_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">counts_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">counts</span>
        <span class="n">bin_edges_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges_ext</span><span class="p">,</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">counts_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">counts_ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Normalize so area = 1</span>
        <span class="c1">#counts_ext /= np.nansum(counts_ext) * (bin_edges_ext[2] - bin_edges_ext[1])</span>
        <span class="c1">#counts_ext = counts_ext / integrate(counts_ext, x=bin_edges_ext)</span>
        <span class="c1">#counts_ext /= counts_ext.max()</span>
        <span class="k">if</span> <span class="n">fit_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                                <span class="mi">5</span><span class="p">,</span>
                                <span class="mi">10000</span><span class="p">)</span>
            <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="n">y_fit</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_params</span><span class="p">)</span>
            <span class="c1">#y_fit / np.nanmax(residuals)</span>
        <span class="n">y_fit</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span>
        <span class="n">y_fit_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_fit</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)],</span>
                                 <span class="n">bin_edges_ext</span><span class="p">,</span>
                                 <span class="n">counts_ext</span><span class="p">)</span>
        <span class="n">y_fit</span> <span class="o">*=</span> <span class="n">y_fit_scalar</span>

        <span class="n">pdf_max</span> <span class="o">=</span> <span class="n">bin_edges_ext</span><span class="p">[</span><span class="n">counts_ext</span> <span class="o">==</span> <span class="n">counts_ext</span><span class="o">.</span><span class="n">max</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#print(&#39;\t\t\tResidual max = {0:.2f} [mag]&#39;.format(pdf_max))</span>

    <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">residuals_nonans</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
        <span class="n">counts_ext</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">x_fit</span><span class="p">)</span>
        <span class="c1">#counts_ext /= counts_ext.max()</span>
        <span class="n">counts_ext</span> <span class="o">=</span> <span class="n">counts_ext</span> <span class="o">/</span> <span class="n">integrate</span><span class="p">(</span><span class="n">counts_ext</span><span class="p">)</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">counts_ext</span> <span class="o">=</span> <span class="n">counts</span>
        <span class="c1">#print integrate(counts_ext, x_fit)</span>

    <span class="k">if</span> <span class="n">fit_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span>
                            <span class="mi">5</span><span class="p">,</span>
                            <span class="mi">10000</span><span class="p">)</span>
        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_params</span><span class="p">)</span>
        <span class="c1">#y_fit / np.nanmax(residuals)</span>

    <span class="n">y_fit</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span>
    <span class="n">y_fit_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_fit</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)],</span>
                             <span class="n">x_fit</span><span class="p">,</span>
                             <span class="n">counts_ext</span><span class="p">)</span>
    <span class="n">y_fit</span> <span class="o">*=</span> <span class="n">y_fit_scalar</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">counts_ext</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-pre&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#ax.set_xlim(xlim)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">residual_thres</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
               <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Residual $A_V$ [mag]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels per Bin&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">anno_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">anno_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="plot_mask_map"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_mask_map">[docs]</a><span class="k">def</span> <span class="nf">plot_mask_map</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">load_original_av</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># colormaps</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>


    <span class="c1"># Set up the data</span>
    <span class="c1"># ---------------</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="k">if</span> <span class="n">load_original_av</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
        <span class="n">av_image</span><span class="p">,</span> <span class="n">av_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">av_image</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_data</span>
        <span class="n">av_header</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_header</span>

    <span class="k">if</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_data_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">av_image_bin</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_data_bin</span>
        <span class="n">av_header_bin</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">av_header_bin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">av_image_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">av_image</span><span class="p">)</span>
        <span class="n">av_header_bin</span> <span class="o">=</span> <span class="n">av_header</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">mask</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span>
    <span class="c1">#color_cycle = [colormap(i) for i in np.linspace(0, 0.9, len(flux_list))]</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ngrids</span><span class="o">=</span><span class="mi">2</span>

    <span class="c1"># Original map</span>
    <span class="c1"># ------------</span>

    <span class="c1"># grid helper</span>
    <span class="n">grid_helper</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">GridHelper</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">av_header</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="c1">#dict(header=av_header),</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">grid_helper</span><span class="o">=</span><span class="n">grid_helper</span><span class="p">),</span>
                             <span class="p">),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="c1">#ax.set_ticklabel_type(&quot;hms&quot;, &quot;dms&quot;)</span>

    <span class="c1">#ax.set_xlabel(&#39;Right Ascension [J2000]&#39;,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>


    <span class="c1"># colorbar</span>
    <span class="c1">#cb = ax.cax.colorbar(im)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Plot contours</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,)</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">av_header_bin</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="c1">#extent=extent,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="p">)</span>



    <span class="c1"># Binned map</span>
    <span class="c1"># ----------</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                     <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                     <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                     <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                     <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                     <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                     <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                     <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                                 <span class="c1">#dict(header=av_header_bin)),</span>
                                 <span class="nb">dict</span><span class="p">(</span><span class="n">grid_helper</span><span class="o">=</span><span class="n">grid_helper</span><span class="p">),</span>
                                 <span class="p">),</span>
                     <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                     <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">av_header_bin</span><span class="p">]</span>
    <span class="c1">#cmap = cm.jet # colormap</span>
    <span class="c1"># show the image</span>
    <span class="n">av_image_bin_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">av_image</span><span class="p">)</span>
    <span class="n">av_image_bin</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">av_image_bin_mask</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image_bin</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>
    <span class="n">im_mask</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_image_bin_mask</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="c1">#ax.set_display_coord_system(&quot;fk5&quot;)</span>
    <span class="c1">#ax.set_ticklabel_type(&quot;hms&quot;, &quot;dms&quot;)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="c1">#cb = ax.cax.colorbar(im)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_residual_map"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_residual_map">[docs]</a><span class="k">def</span> <span class="nf">plot_residual_map</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dgr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">anno_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vlimits</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># colormaps</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ngrids</span><span class="o">=</span><span class="mi">2</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span> <span class="c1"># colormap</span>
    <span class="c1">#color_cycle = [colormap(i) for i in np.linspace(0, 0.9, len(flux_list))]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ngrids</span> <span class="o">*</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># grid helper</span>
    <span class="n">grid_helper</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">GridHelper</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">grid_helper</span><span class="o">=</span><span class="n">grid_helper</span><span class="p">),</span>
                             <span class="p">),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Initial map</span>
    <span class="c1"># -----------</span>
    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">anno_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Fractional Mask</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">anno_text</span><span class="p">)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="c1"># Post-residual masking map</span>
    <span class="c1"># -----------</span>
    <span class="c1"># create axes</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># show the image</span>
        <span class="n">residuals_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
        <span class="n">residuals_masked</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">residuals_masked</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Asthetics</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

        <span class="k">if</span> <span class="n">anno_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual Mask</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">anno_text</span><span class="p">)</span>

        <span class="c1"># colorbar</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># plot limits</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Write label to colorbar</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="plot_av_bin_map"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_av_bin_map">[docs]</a><span class="k">def</span> <span class="nf">plot_av_bin_map</span><span class="p">(</span><span class="n">av_map</span><span class="p">,</span> <span class="n">av_bin_map</span><span class="p">,</span> <span class="n">av_header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">av_header_bin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># colormaps</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_ncar</span>
    <span class="c1">#color_cycle = [colormap(i) for i in np.linspace(0, 0.9, len(flux_list))]</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># Original map</span>
    <span class="c1"># ------------</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">av_header</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span> <span class="c1"># colormap</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_map</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="c1"># Binned map</span>
    <span class="c1"># ----------</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">av_header_bin</span><span class="p">)),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span> <span class="c1"># colormap</span>
    <span class="c1"># show the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">av_bin_map</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1">#norm=matplotlib.colors.LogNorm()</span>
            <span class="c1">#vmin=-1,</span>
            <span class="c1">#vmax=1</span>
            <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">cax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [Mag]&#39;</span><span class="p">,)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_dgr_intercept_progression"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_dgr_intercept_progression">[docs]</a><span class="k">def</span> <span class="nf">plot_dgr_intercept_progression</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span> <span class="k">as</span> <span class="n">integrate</span>

    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">)</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nrows</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrows</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">nrows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">iter_dict</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;masking_var&#39;</span><span class="p">]</span>

        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iter_dict</span><span class="p">)</span>
        <span class="n">dgrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
        <span class="n">intercepts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iter_dict</span><span class="p">):</span>
            <span class="n">dgrs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;dgr&#39;</span><span class="p">]</span>
            <span class="n">intercepts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>
            <span class="n">npix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">iter_dict</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">dgrs</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                 <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">intercepts</span><span class="p">,</span>
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                 <span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;Number of Unmasked Pixels&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;DGR [10$^{-20}$ cm$^2$ mag]&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Intercept [mag]&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">vel_range</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;vel_range&#39;</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vel_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">r&#39;$\Delta_V$ = {0:.0f} km/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_map_movie"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_map_movie">[docs]</a><span class="k">def</span> <span class="nf">plot_map_movie</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>

    <span class="kn">import</span> <span class="nn">moviepy.editor</span> <span class="kn">as</span> <span class="nn">mpy</span>
    <span class="kn">from</span> <span class="nn">moviepy.video.io.bindings</span> <span class="kn">import</span> <span class="n">mplfig_to_npimage</span>

    <span class="n">residuals_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anno_text_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">resid_min_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
    <span class="n">resid_max_abs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>

    <span class="k">for</span> <span class="n">parent_iter</span> <span class="ow">in</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">:</span>
        <span class="n">mask_dict</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">parent_iter</span><span class="p">][</span><span class="s1">&#39;masking_var&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mask_iter</span> <span class="ow">in</span> <span class="n">mask_dict</span><span class="p">:</span>
            <span class="n">anno_text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Parent iter = &#39;</span> <span class="o">+</span> \
                                  <span class="s1">&#39;{0:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent_iter</span><span class="p">)</span> <span class="o">+</span> \
                                  <span class="s1">&#39;, mask iter = {0:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_iter</span><span class="p">))</span>
            <span class="n">mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;mask_residuals&#39;</span><span class="p">])</span>
            <span class="c1"># grab residuals, record global limits</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span>
            <span class="n">residuals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
            <span class="n">resid_min</span><span class="p">,</span> <span class="n">resid_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resid_min</span> <span class="o">&lt;</span> <span class="n">resid_min_abs</span><span class="p">:</span>
                <span class="n">resid_min_abs</span> <span class="o">=</span> <span class="n">resid_min</span>
            <span class="k">if</span> <span class="n">resid_max</span> <span class="o">&gt;</span> <span class="n">resid_max_abs</span><span class="p">:</span>
                <span class="n">resid_max_abs</span> <span class="o">=</span> <span class="n">resid_max</span>

    <span class="k">def</span> <span class="nf">make_frame</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_residual_map</span><span class="p">(</span><span class="n">residuals_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                <span class="n">anno_text</span><span class="o">=</span><span class="n">anno_text_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                <span class="n">return_fig</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">mask</span><span class="o">=</span><span class="n">mask_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                <span class="n">header</span><span class="o">=</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_header</span><span class="p">,</span>
                                <span class="n">vlimits</span><span class="o">=</span><span class="p">[</span><span class="n">resid_min_abs</span><span class="p">,</span> <span class="n">resid_max_abs</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">mplfig_to_npimage</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># Make the movie</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">mpy</span><span class="o">.</span><span class="n">VideoClip</span><span class="p">(</span><span class="n">make_frame</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">residuals_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mp4&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gif&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_gif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_residual_hist_movie"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_residual_hist_movie">[docs]</a><span class="k">def</span> <span class="nf">plot_residual_hist_movie</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>

    <span class="kn">import</span> <span class="nn">moviepy.editor</span> <span class="kn">as</span> <span class="nn">mpy</span>
    <span class="kn">from</span> <span class="nn">moviepy.video.io.bindings</span> <span class="kn">import</span> <span class="n">mplfig_to_npimage</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
    <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span>

    <span class="n">residuals_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">counts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">residual_thres_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fit_params_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anno_text_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">resid_max_abs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>

    <span class="k">for</span> <span class="n">parent_iter</span> <span class="ow">in</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">:</span>
        <span class="n">mask_dict</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">iter_vars</span><span class="p">[</span><span class="n">parent_iter</span><span class="p">][</span><span class="s1">&#39;masking_var&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mask_iter</span> <span class="ow">in</span> <span class="n">mask_dict</span><span class="p">:</span>
            <span class="n">npix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
            <span class="n">anno_text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;N$_{\rm pix}$ = &#39;</span> <span class="o">+</span> \
                                  <span class="s1">&#39;{0:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">+</span> \
                                  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parent iter = &#39;</span> <span class="o">+</span> \
                                  <span class="s1">&#39;{0:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent_iter</span><span class="p">)</span> <span class="o">+</span> \
                                  <span class="s1">&#39;, mask iter = {0:02d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_iter</span><span class="p">))</span>

            <span class="n">fit_params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;fit_params&#39;</span><span class="p">])</span>
            <span class="n">residual_thres_list</span><span class="o">.</span>\
                    <span class="n">append</span><span class="p">(</span><span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;residual_threshold&#39;</span><span class="p">])</span>

            <span class="c1"># grab residuals, record global limits</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">mask_dict</span><span class="p">[</span><span class="n">mask_iter</span><span class="p">][</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="n">residuals</span> <span class="o">==</span> <span class="n">residuals</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">mask_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">factor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">/</span> <span class="n">simps</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>


            <span class="n">residuals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
            <span class="n">counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

            <span class="n">resid_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resid_max</span> <span class="o">&gt;</span> <span class="n">resid_max_abs</span><span class="p">:</span>
                <span class="n">resid_max_abs</span> <span class="o">=</span> <span class="n">resid_max</span>

    <span class="k">def</span> <span class="nf">make_frame</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_mask_residuals</span><span class="p">(</span>
                                  <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                  <span class="n">counts</span><span class="o">=</span><span class="n">counts_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                  <span class="c1">#bin_edges=residuals_list[int(t)][1],</span>
                                  <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span>
                                  <span class="n">anno_text</span><span class="o">=</span><span class="n">anno_text_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                  <span class="n">x_fit</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                  <span class="n">fit_params</span><span class="o">=</span><span class="n">fit_params_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                  <span class="n">residual_thres</span><span class="o">=</span><span class="n">residual_thres_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                                  <span class="n">return_fig</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">resid_max_abs</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">mplfig_to_npimage</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># Make the movie</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">mpy</span><span class="o">.</span><span class="n">VideoClip</span><span class="p">(</span><span class="n">make_frame</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">residuals_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mp4&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gif&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_gif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_av_vs_nhi"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_av_vs_nhi">[docs]</a><span class="k">def</span> <span class="nf">plot_av_vs_nhi</span><span class="p">(</span><span class="n">nhi</span><span class="p">,</span> <span class="n">av</span><span class="p">,</span> <span class="n">av_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">fit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">contour_plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">plot_median</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;linear&#39;</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
    <span class="kn">from</span> <span class="nn">astroML.plotting</span> <span class="kn">import</span> <span class="n">scatter_contour</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">import</span> <span class="nn">myplotting</span> <span class="kn">as</span> <span class="nn">myplt</span>

    <span class="c1"># set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="c1">#plt.rcdefaults()</span>

    <span class="c1"># color map</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span>

    <span class="c1"># color cycle, grabs colors from cmap</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axes.color_cycle&#39;</span><span class="p">:</span> <span class="n">color_cycle</span><span class="p">,</span> <span class="c1"># colors of different plots</span>
             <span class="p">}</span>
    <span class="c1">#plt.rcparams.update(params)</span>

    <span class="n">myplt</span><span class="o">.</span><span class="n">set_color_cycle</span><span class="p">(</span><span class="n">num_colors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">))</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="c1">#cbar_mode=&#39;single&#39;,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="p">)</span>

    <span class="c1"># Drop the NaNs from the images</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">av_error</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="n">av_error</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">av</span> <span class="o">==</span> <span class="n">av</span><span class="p">)</span> <span class="o">&amp;</span>\
                           <span class="p">(</span><span class="n">nhi</span> <span class="o">==</span> <span class="n">nhi</span><span class="p">)</span>
                           <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">av_error</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">or</span> \
            <span class="nb">type</span><span class="p">(</span><span class="n">av_error</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">av</span> <span class="o">==</span> <span class="n">av</span><span class="p">)</span> <span class="o">&amp;</span>\
                           <span class="p">(</span><span class="n">nhi</span> <span class="o">==</span> <span class="n">nhi</span><span class="p">)</span> <span class="o">&amp;</span>\
                           <span class="p">(</span><span class="n">av_error</span> <span class="o">==</span> <span class="n">av_error</span><span class="p">)</span> <span class="o">&amp;</span>\
                           <span class="p">(</span><span class="n">av_error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                           <span class="p">)</span>
        <span class="n">av_error_nonans</span> <span class="o">=</span> <span class="n">av_error</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="n">av_nonans</span> <span class="o">=</span> <span class="n">av</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">nhi_nonans</span> <span class="o">=</span> <span class="n">nhi</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="c1"># Create plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">av_nonans</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">av_nonans</span><span class="p">)</span>
        <span class="n">xscalar</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">xmax</span>
        <span class="n">yscalar</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">ymax</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">xscalar</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">xscalar</span><span class="p">,</span>
                  <span class="n">ymin</span> <span class="o">-</span> <span class="n">yscalar</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">yscalar</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">contour_plot</span><span class="p">:</span>

        <span class="n">contour_range</span> <span class="o">=</span> <span class="p">((</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                         <span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">myplt</span><span class="o">.</span><span class="n">truncate_colormap</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">l1</span> <span class="o">=</span> <span class="n">myplt</span><span class="o">.</span><span class="n">scatter_contour</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                             <span class="n">av_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                             <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">log_counts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                             <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                             <span class="n">histogram2d_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                                   <span class="nb">range</span><span class="o">=</span><span class="n">contour_range</span><span class="p">),</span>
                             <span class="n">plot_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                                            <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                             <span class="n">contour_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                               <span class="c1">#cmap=plt.cm.binary,</span>
                                               <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                               <span class="c1">#cmap=cmap,</span>
                                               <span class="p">),</span>
                             <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">av_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">yerr</span><span class="o">=</span><span class="p">(</span><span class="n">av_error_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_median</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmedian</span><span class="p">,</span> <span class="n">binned_statistic</span>
        <span class="n">x_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">x_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1">#x_median = np.arange(6.5, 9, 0.3)</span>
        <span class="n">y_median</span><span class="p">,</span> <span class="n">x_median</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">,</span> <span class="n">av_nonans</span><span class="p">,</span>
                                    <span class="n">statistic</span><span class="o">=</span><span class="n">nanmedian</span><span class="p">,</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="n">x_median</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">x_median</span> <span class="o">=</span> <span class="n">x_median</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_median</span> <span class="o">=</span> <span class="n">x_median</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_median</span><span class="p">)]</span>
        <span class="n">y_median</span> <span class="o">=</span> <span class="n">y_median</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_median</span><span class="p">)]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_median</span><span class="p">,</span>
                <span class="n">y_median</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median value&#39;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mf">4.5</span>
                <span class="p">)</span>


    <span class="c1"># Plot sensitivies</span>
    <span class="c1">#av_limit = np.median(av_errors[0])</span>
    <span class="c1">#ax.axvline(av_limit, color=&#39;k&#39;, linestyle=&#39;--&#39;)</span>

    <span class="c1"># Plot 1 to 1 pline</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">av_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">av_error_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                           <span class="n">cov</span><span class="o">=</span><span class="bp">True</span>
                           <span class="p">)</span>

        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">y_fit</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dgr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_fit</span> <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>
        <span class="n">y_fit_error</span> <span class="o">=</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dgr_error&#39;</span><span class="p">],</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">]</span>
        <span class="n">y_poly_fit</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_fit</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span>
                <span class="n">y_fit</span><span class="p">,</span>
                <span class="c1">#color=&#39;0.5&#39;,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span>\
                    <span class="s1">&#39;MLE fit: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;DGR = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dgr&#39;</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39;$^{+</span><span class="si">%.2f</span><span class="s1">}_{-</span><span class="si">%.2f</span><span class="s1">}$ &#39;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;dgr_error&#39;</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Intercept = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39;$^{+</span><span class="si">%.2f</span><span class="s1">}_{-</span><span class="si">%.2f</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s1">&#39;intercept_error&#39;</span><span class="p">],</span>
                <span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span>
                <span class="n">y_poly_fit</span><span class="p">,</span>
                <span class="c1">#color=&#39;r&#39;,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span>\
                    <span class="s1">&#39;Poly Scatter fit: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;DGR = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39; $\pm$ {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Intercept = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39; $\pm$ {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_median</span><span class="p">:</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x_median</span><span class="p">,</span> <span class="n">y_median</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">y_poly_fit</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_fit</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span> <span class="c1"># this is your &#39;straight line&#39; y=f(x)</span>
                <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">x</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_median</span><span class="p">,</span> <span class="n">y_median</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># your data x, y to fit</span>
            <span class="n">y_poly_fit</span> <span class="o">=</span> <span class="n">x_fit</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span>
                <span class="n">y_poly_fit</span><span class="p">,</span>
                <span class="c1">#color=&#39;r&#39;,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span>\
                    <span class="s1">&#39;Poly Median fit: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> \
                    <span class="s1">&#39;DGR = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39; $\pm$ &#39;</span> <span class="o">+</span> <span class="s1">&#39;{0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Intercept = {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">r&#39; $\pm$ &#39;</span> <span class="o">+</span> <span class="s1">&#39;{0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="p">)</span>


    <span class="c1"># Annotations</span>
    <span class="n">anno_xpos</span> <span class="o">=</span> <span class="mf">0.95</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nonposx</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nonposy</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Adjust asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;$N($H$\textsc{i}) \times\,10^{20}$ cm$^{-2}$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;$A_V$ [mag]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_nh2_vs_nhi"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_nh2_vs_nhi">[docs]</a><span class="k">def</span> <span class="nf">plot_nh2_vs_nhi</span><span class="p">(</span><span class="n">nhi</span><span class="p">,</span> <span class="n">nh2</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">savedir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fit_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contour_plot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;linear&#39;</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span>
        <span class="n">std</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
    <span class="kn">from</span> <span class="nn">astroML.plotting</span> <span class="kn">import</span> <span class="n">scatter_contour</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">import</span> <span class="nn">myplotting</span> <span class="kn">as</span> <span class="nn">myplt</span>

    <span class="c1"># set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="c1">#plt.rcdefaults()</span>

    <span class="c1"># color map</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span>

    <span class="c1"># color cycle, grabs colors from cmap</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;axes.color_cycle&#39;</span><span class="p">:</span> <span class="n">color_cycle</span><span class="p">,</span> <span class="c1"># colors of different plots</span>
             <span class="p">}</span>
    <span class="c1">#plt.rcparams.update(params)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">))</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="c1">#cbar_mode=&#39;single&#39;,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                 <span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">nh2</span> <span class="o">==</span> <span class="n">nh2</span><span class="p">)</span> <span class="o">&amp;</span>\
                       <span class="p">(</span><span class="n">nhi</span> <span class="o">==</span> <span class="n">nhi</span><span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">nh2_nonans</span> <span class="o">=</span> <span class="n">nh2</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">nhi_nonans</span> <span class="o">=</span> <span class="n">nhi</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="c1"># Create plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">contour_range</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">x_scalar</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">)</span>
        <span class="n">y_scalar</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nh2_nonans</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_scalar</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_scalar</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nh2_nonans</span><span class="p">)</span> <span class="o">-</span> <span class="n">y_scalar</span><span class="p">,</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nh2_nonans</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_scalar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">contour_plot</span><span class="p">:</span>
        <span class="n">contour_range</span> <span class="o">=</span> <span class="p">((</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                         <span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">myplt</span><span class="o">.</span><span class="n">truncate_colormap</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">l1</span> <span class="o">=</span> <span class="n">myplt</span><span class="o">.</span><span class="n">scatter_contour</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                             <span class="n">nh2_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                             <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">log_counts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                             <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                             <span class="n">histogram2d_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                                   <span class="nb">range</span><span class="o">=</span><span class="n">contour_range</span><span class="p">),</span>
                             <span class="n">plot_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                                            <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                             <span class="n">contour_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                               <span class="c1">#cmap=plt.cm.binary,</span>
                                               <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                               <span class="c1">#cmap=cmap,</span>
                                               <span class="p">),</span>
                             <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">nhi_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="n">nh2_nonans</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="c1">#yerr=(av_error_nonans.ravel()),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span>
                <span class="p">)</span>

    <span class="c1"># Annotations</span>
    <span class="n">anno_xpos</span> <span class="o">=</span> <span class="mf">0.95</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nonposx</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nonposy</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Adjust asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;$N($H$\textsc{i}) \times\,10^{20}$ cm$^{-2}$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;$N($H$_2) \times\,10^{20}$ cm$^{-2}$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savedir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="plot_hi_spectrum"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_hi_spectrum">[docs]</a><span class="k">def</span> <span class="nf">plot_hi_spectrum</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">plot_co</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">hi_mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">co_mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Plots a heat map of likelihoodelation values as a function of velocity</span>
<span class="sd">    width and velocity center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud : cloudpy.Cloud</span>
<span class="sd">        If provided, properties taken from cloud.props.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmedian</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>

    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span> <span class="o">/</span> <span class="mf">1.618</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                    <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">statistic</span> <span class="o">=</span> <span class="n">nanmedian</span>
    <span class="n">statistic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span>

    <span class="n">hi_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_data</span><span class="p">)</span>

    <span class="c1">#hi_data[:, cloud.region_mask] = np.nan</span>

    <span class="c1"># Integrate HI cube for masked and unmasked</span>
    <span class="n">hi_mask</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">region_mask</span>
    <span class="n">co_mask</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">region_mask</span>
    <span class="c1">#if hi_mask is None:</span>
    <span class="c1">#    mask = cloud.mask</span>
    <span class="c1">#else:</span>
    <span class="c1">#    mask = (hi_mask) | (cloud.mask)</span>

    <span class="c1">#hi_spectrum_masked = statistic(hi_data[:, mask], axis=1)</span>
    <span class="n">hi_spectrum_unmasked</span> <span class="o">=</span> \
            <span class="n">statistic</span><span class="p">(</span><span class="n">hi_data</span><span class="p">[:,</span> <span class="o">~</span><span class="n">hi_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hi_spectrum_unmasked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hi_std_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">hi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">hi_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="o">~</span><span class="n">hi_mask</span><span class="p">])</span>
            <span class="n">hi_spectrum_unmasked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">statistic</span><span class="p">(</span><span class="n">hi</span><span class="p">)</span>

    <span class="n">hi_std_spectrum</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">hi_data</span><span class="p">[:,</span> <span class="o">~</span><span class="n">hi_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
            <span class="n">hi_spectrum_unmasked</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;Median H$\textsc{i}$&#39;</span><span class="p">,</span>
            <span class="n">drawstyle</span> <span class="o">=</span> <span class="s1">&#39;steps-mid&#39;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">hi_std_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                <span class="n">hi_std_spectrum</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$\sigma_{HI}$&#39;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="s1">&#39;vel_center_fits&#39;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span> <span class="n">cloud</span><span class="o">.</span><span class="n">vel_center_fits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">,</span>
                <span class="p">)</span>


        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Component&#39;</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">cloud</span><span class="o">.</span><span class="n">vel_center_fits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">plot_co</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
        <span class="c1">#try cloud.co_vel_axis():</span>

            <span class="n">co_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">co_data</span><span class="p">)</span>
            <span class="c1">#co_data[:, cloud.region_mask] = np.nan</span>

            <span class="c1">#co_data[co_data &lt; 3 * 0.17] = np.nan</span>

            <span class="n">co_spectrum</span> <span class="o">=</span> \
                    <span class="n">statistic</span><span class="p">(</span><span class="n">co_data</span><span class="p">[:,</span> <span class="o">~</span><span class="n">co_mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">co_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">co_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">co_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">co_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="o">~</span><span class="n">co_mask</span><span class="p">])</span>
                    <span class="n">co_spectrum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">statistic</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>

            <span class="n">co_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">hi_spectrum_unmasked</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">co_spectrum</span> <span class="o">=</span> <span class="n">co_spectrum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">co_spectrum</span><span class="p">)</span> <span class="o">*</span> <span class="n">co_scalar</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">co_vel_axis</span><span class="p">,</span>
                    <span class="n">co_spectrum</span><span class="p">,</span>
                    <span class="c1">#color=&#39;k&#39;,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;Median $^{12}$CO $\times$&#39;</span> <span class="o">+</span> \
                           <span class="s1">&#39;{0:.0f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co_scalar</span><span class="p">),</span>
                    <span class="n">drawstyle</span> <span class="o">=</span> <span class="s1">&#39;steps-mid&#39;</span>
                    <span class="p">)</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No CO data present&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">cloud</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;hi_velocity_range_max&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
               <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">vel_center</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
               <span class="p">)</span>

    <span class="c1"># plot limits</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity [km/s]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;T$_b$ [K]&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">co_data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">co_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">co_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">co_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="n">co</span><span class="p">[</span><span class="n">co_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">co</span><span class="p">,</span>
                            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;vel = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">co_vel_axis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; km/s, &#39;</span> <span class="o">+</span> \
                      <span class="s1">&#39;median = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">ravel</span><span class="p">())))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/usr/users/ezbc/Desktop/cospectra/&#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;cospectrum_&#39;</span> <span class="o">+</span> <span class="n">cloud</span><span class="o">.</span><span class="n">region</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_co_spectra"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_co_spectra">[docs]</a><span class="k">def</span> <span class="nf">plot_co_spectra</span><span class="p">(</span><span class="n">clouds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Plots a heat map of likelihoodelation values as a function of velocity</span>
<span class="sd">    width and velocity center.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud : cloudpy.Cloud</span>
<span class="sd">        If provided, properties taken from cloud.props.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmedian</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>

    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span> <span class="o">/</span> <span class="mf">1.618</span><span class="p">),</span>
              <span class="c1">#&#39;figure.titlesize&#39;: font_scale,</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                    <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">statistic</span> <span class="o">=</span> <span class="n">nanmedian</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Integrate CO cube for masked and unmasked</span>
    <span class="k">for</span> <span class="n">cloud</span> <span class="ow">in</span> <span class="n">clouds</span><span class="p">:</span>
        <span class="n">co_spectrum_masked</span> <span class="o">=</span> <span class="n">statistic</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">co_data</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">co_vel_axis</span><span class="p">,</span>
                <span class="n">co_spectrum_unmasked</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">cloud</span><span class="o">.</span><span class="n">region_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                <span class="n">drawstyle</span> <span class="o">=</span> <span class="s1">&#39;steps-mid&#39;</span>
                <span class="p">)</span>

    <span class="c1"># plot limits</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Velocity [km/s]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;T$_b$ [K]&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_nhi_map"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_nhi_map">[docs]</a><span class="k">def</span> <span class="nf">plot_nhi_map</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nhi_image</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">anno_text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vlimits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">plot_contours</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">log_scale</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">av_contours</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">av_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># Import external modules</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_grid</span> <span class="kn">import</span> <span class="n">AxesGrid</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">pywcsgrid2</span> <span class="kn">as</span> <span class="nn">wcs</span>
    <span class="kn">import</span> <span class="nn">pywcs</span>
    <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">cm</span> <span class="c1"># colormaps</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>


    <span class="c1"># Set up the data</span>
    <span class="c1"># ---------------</span>
    <span class="k">if</span> <span class="n">cloud</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">.</span><span class="n">props</span>

    <span class="n">av_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">av_header_bin</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_filename_bin</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">av_header_bin</span> <span class="o">=</span> <span class="n">av_header</span>

    <span class="c1"># Set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gnuplot</span>
    <span class="c1">#color_cycle = [colormap(i) for i in np.linspace(0, 0.9, len(flux_list))]</span>
    <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">),</span>
             <span class="p">}</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

    <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ngrids</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># Original map</span>
    <span class="c1"># ------------</span>

    <span class="c1"># grid helper</span>
    <span class="n">grid_helper</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">GridHelper</span><span class="p">(</span><span class="n">wcs</span><span class="o">=</span><span class="n">av_header</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">AxesGrid</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">nrows_ncols</span><span class="o">=</span><span class="n">nrows_ncols</span><span class="p">,</span>
                 <span class="n">ngrids</span><span class="o">=</span><span class="n">ngrids</span><span class="p">,</span>
                 <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;each&quot;</span><span class="p">,</span>
                 <span class="n">cbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                 <span class="n">cbar_pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
                 <span class="n">cbar_size</span><span class="o">=</span><span class="s1">&#39;3%&#39;</span><span class="p">,</span>
                 <span class="n">axes_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">axes_class</span><span class="o">=</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                             <span class="c1">#dict(header=av_header),</span>
                             <span class="nb">dict</span><span class="p">(</span><span class="n">grid_helper</span><span class="o">=</span><span class="n">grid_helper</span><span class="p">),</span>
                             <span class="p">),</span>
                 <span class="n">aspect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">label_mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                 <span class="n">share_all</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># create axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">vlimits</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vlimits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Plot!</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nhi_image_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">)</span>
        <span class="n">nhi_image</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1">#nhi_image_mask[~mask] = np.nan</span>

        <span class="n">im_mask</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nhi_image_mask</span><span class="p">,</span>
                            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span>
                            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">vmax</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_mask</span><span class="p">)</span>
        <span class="c1">#cmap.set_bad(color=&#39;w&#39;)</span>

        <span class="c1"># Write label to colorbar</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;N(H$\textsc{i}$) [10$^{20}$ cm$^{-2}$]&#39;</span><span class="p">)</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vlimits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># Plot contours</span>
    <span class="k">if</span> <span class="n">plot_contours</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,)</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">av_header_bin</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="c1">#extent=extent,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">av_header_bin</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">region_mask</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                <span class="c1">#extent=extent,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">if</span> <span class="n">av_contours</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">av_data</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">av_contours</span><span class="p">,</span>
                <span class="c1">#extent=extent,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="c1"># Asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_display_coord_system</span><span class="p">(</span><span class="s2">&quot;fk5&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ticklabel_type</span><span class="p">(</span><span class="s2">&quot;hms&quot;</span><span class="p">,</span> <span class="s2">&quot;dms&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension [J2000]&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination [J2000]&#39;</span><span class="p">,)</span>

    <span class="c1"># colorbar</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="c1">#cmap.set_bad(color=&#39;w&#39;)</span>

    <span class="c1"># Write label to colorbar</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label_text</span><span class="p">(</span><span class="s1">r&#39;N(H$\textsc{i}$) [10$^{20}$ cm$^{-2}$]&#39;</span><span class="p">)</span>

    <span class="c1"># plot limits</span>
    <span class="n">limits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">anno_text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">anno_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="make_nhi_movie"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.make_nhi_movie">[docs]</a><span class="k">def</span> <span class="nf">make_nhi_movie</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">moviepy.editor</span> <span class="kn">as</span> <span class="nn">mpy</span>
    <span class="kn">from</span> <span class="nn">moviepy.video.io.bindings</span> <span class="kn">import</span> <span class="n">mplfig_to_npimage</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
    <span class="kn">from</span> <span class="nn">myimage_analysis</span> <span class="kn">import</span> <span class="n">calculate_nhi</span>

    <span class="n">nhi_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anno_text_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nhi_min_abs</span><span class="p">,</span> <span class="n">nhi_max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>

    <span class="n">hi_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_filename</span><span class="p">)</span>
    <span class="n">hi_data</span><span class="p">[</span><span class="n">hi_data</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">av_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">av_filename</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">widths</span><span class="p">):</span>

        <span class="n">vel_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">cloud</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                     <span class="n">cloud</span><span class="o">.</span><span class="n">vel_center</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">nhi_image</span> <span class="o">=</span> <span class="n">calculate_nhi</span><span class="p">(</span><span class="n">cube</span><span class="o">=</span><span class="n">hi_data</span><span class="p">,</span>
                            <span class="n">velocity_axis</span><span class="o">=</span><span class="n">cloud</span><span class="o">.</span><span class="n">hi_vel_axis</span><span class="p">,</span>
                            <span class="n">velocity_range</span><span class="o">=</span><span class="n">vel_range</span><span class="p">,</span>
                            <span class="p">)</span>

        <span class="n">anno_text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;HI width = {0:.0f} km/s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
        <span class="n">nhi_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">)</span>

        <span class="n">nhi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">[</span><span class="n">av_data</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">nhi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">nhi_image</span><span class="p">[</span><span class="n">av_data</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">nhi_min</span> <span class="o">&lt;</span> <span class="n">nhi_min_abs</span><span class="p">:</span>
            <span class="n">nhi_min_abs</span> <span class="o">=</span> <span class="n">nhi_min</span>
        <span class="k">if</span> <span class="n">nhi_max</span> <span class="o">&gt;</span> <span class="n">nhi_max_abs</span><span class="p">:</span>
            <span class="n">nhi_max_abs</span> <span class="o">=</span> <span class="n">nhi_max</span>

    <span class="k">def</span> <span class="nf">make_frame</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_nhi_map</span><span class="p">(</span><span class="n">cloud</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span>
                           <span class="n">nhi_image</span><span class="o">=</span><span class="n">nhi_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                           <span class="n">anno_text</span><span class="o">=</span><span class="n">anno_text_list</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span>
                           <span class="n">return_fig</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="c1">#mask=mask_list[int(t)],</span>
                           <span class="c1">#header=cloud.av_header,</span>
                           <span class="n">vlimits</span><span class="o">=</span><span class="p">[</span><span class="n">nhi_min_abs</span><span class="p">,</span> <span class="n">nhi_max_abs</span><span class="p">],</span>
                           <span class="n">plot_contours</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">av_contours</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,],</span>
                           <span class="n">av_data</span><span class="o">=</span><span class="n">av_data</span><span class="p">,</span>
                           <span class="n">log_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="p">)</span>

        <span class="k">return</span> <span class="n">mplfig_to_npimage</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># Make the movie</span>
    <span class="n">animation</span> <span class="o">=</span> <span class="n">mpy</span><span class="o">.</span><span class="n">VideoClip</span><span class="p">(</span><span class="n">make_frame</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nhi_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mp4&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gif&#39;</span><span class="p">:</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">write_gif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_hi_width_correlation"><a class="viewcode-back" href="../docs_rst/cloudpy.html#cloudpy.plot_hi_width_correlation">[docs]</a><span class="k">def</span> <span class="nf">plot_hi_width_correlation</span><span class="p">(</span><span class="n">widths</span><span class="p">,</span> <span class="n">correlations</span><span class="p">,</span>
        <span class="n">correlations_masked_2mass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">correlations_masked_planck</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">correlation_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>

    <span class="c1"># import external modules</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
    <span class="kn">import</span> <span class="nn">myplotting</span> <span class="kn">as</span> <span class="nn">myplt</span>

    <span class="c1"># set up plot aesthetics</span>
    <span class="c1"># ----------------------</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">;</span><span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">myplt</span><span class="o">.</span><span class="n">set_color_cycle</span><span class="p">(</span><span class="n">num_colors</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Create figure instance</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">))</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">correlation_error</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="p">(</span><span class="n">correlation_error</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">widths</span><span class="p">,</span>
                <span class="n">correlations</span><span class="p">,</span>
                <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="c1">#color=&#39;k&#39;,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lee+12 Mask, Lee+12 2MASS $A_V$&#39;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span>
                <span class="p">)</span>
    <span class="k">if</span> <span class="n">correlations_masked_2mass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">widths</span><span class="p">,</span>
                    <span class="n">correlations_masked_planck</span><span class="p">,</span>
                    <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="c1">#color=&#39;k&#39;,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                    <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;Diffuse Mask, Planck $A_V$&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">widths</span><span class="p">,</span>
                    <span class="n">correlations_masked_2mass</span><span class="p">,</span>
                    <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="c1">#color=&#39;k&#39;,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                    <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;Diffuse Mask, Lee+12 2MASS $A_V$&#39;</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

    <span class="c1">#ax.set_xscale(scale[0], nonposx = &#39;clip&#39;)</span>
    <span class="c1">#ax.set_yscale(scale[1], nonposy = &#39;clip&#39;)</span>

    <span class="k">if</span> <span class="n">limits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Adjust asthetics</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">r&#39;HI width [km/s]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">r&#39;Correlation Coeff.&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></div>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">custom_modules 0.0.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Elijah Bernstein-Cooper.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>